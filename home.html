<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <title>会員ページ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{--border:#e5e7eb}
    html,body{height:100%} body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;background:#fff}
    .wrap{min-height:100dvh;display:flex;flex-direction:column;padding:16px}
    .card{margin:0 auto;width:min(720px,96vw);border:1px solid var(--border);border-radius:16px;padding:16px}
    h1{margin:0 0 8px}
    .rows{display:grid;gap:10px}
    .row{display:flex;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff}
    .key{opacity:.75}
    .actions{margin-top:12px;display:flex;gap:10px;justify-content:flex-end}
    .btn{appearance:none;border:1px solid var(--border);border-radius:12px;padding:10px 14px;background:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap"><div class="card">
    <h1>会員ページ</h1>
    <div id="sub" style="opacity:.75">読み込み中…</div>
    <div class="rows" id="rows" style="display:none">
      <div class="row"><div class="key">所属店舗</div><div id="v_store">—</div></div>
      <div class="row"><div class="key">職員コード</div><div id="v_code">—</div></div>
      <div class="row"><div class="key">氏名</div><div id="v_name">—</div></div>
    </div>
    <div class="actions"><button id="logout" class="btn">ログアウト</button></div>
  </div></div>

<script>
  const LIFF_ID = "2007972627-vnAq4qbB";
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby042IR537_dOHo0XTri9kTgdwZVRQQFO_vIJuFLW3_gSkmWQYoVqx0vBFxuDSTAxZajQ/exec"; // ← 差し替え
  const URL_REGISTER = "./register.html";

  const $ = (id)=>document.getElementById(id);

  async function callServer(payload){
    const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
    const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
    if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
    return j;
  }

  (async ()=>{
    try{
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      const idToken = liff.getIDToken();

      const st = await callServer({ idToken, action:"status" });
      if(!st.bound){ location.replace(URL_REGISTER); return; }

      $('v_store').textContent = st.store || '(未登録)';
      $('v_code').textContent  = st.staffCode || '(未登録)';
      $('v_name').textContent  = st.displayName || '会員';
      $('rows').style.display = '';
      $('sub').textContent = 'ようこそ！';
    }catch(err){
      console.error(err); $('sub').textContent = 'エラー：'+(err?.message||err);
    }
  })();

  $('logout').addEventListener('click', ()=>{
    try{ if(liff.isLoggedIn()) liff.logout(); }catch(e){}
    location.replace("./index.html");
  });
</script>
</body>
</html>
