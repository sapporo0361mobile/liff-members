<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>トーク</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;display:flex;flex-direction:column}

/* ヘッダー */
.header{display:flex;align-items:center;gap:8px;padding:12px;background:#fff;border-bottom:1px solid rgba(2,6,23,.08)}
.back{appearance:none;border:none;background:none;font-size:16px;cursor:pointer;padding:8px}
.title{font-weight:800;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub{font-size:12px;opacity:.7}
.header-right{margin-left:auto;position:relative;display:flex;align-items:center}
.header-right a{display:inline-flex;align-items:center;gap:4px;color:#0f172a;text-decoration:none;padding:6px}
.badge-dot{position:absolute;right:0;top:0;min-width:16px;height:16px;padding:0 4px;border-radius:999px;background:#ef4444;color:#fff;font-size:10px;line-height:16px;font-weight:700;display:none;transform:translate(30%,-30%)}

/* 準備中＆完了 */
.prep{padding:8px 12px;background:#fff3cd;border:1px solid #ffe8a1;color:#663c00;font-size:14px}
.ready{padding:8px 12px;background:#e6ffed;border:1px solid #b7f5c9;color:#135f2d;font-size:14px;display:none}

/* スピナー */
.loader{display:none;justify-content:center;align-items:center;padding:12px}
.spin{width:18px;height:18px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:#06c755;animation:sp 1s linear infinite;margin-right:8px}
@keyframes sp{to{transform:rotate(360deg)}}

/* チャット */
.chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#f6f8fc}
.msg{max-width:80%;padding:8px 12px;border-radius:14px;word-break:break-word}
.me{align-self:flex-end;background:#dcfce7;border:1px solid rgba(2,6,23,.1)}
.them{align-self:flex-start;background:#fff;border:1px solid rgba(2,6,23,.12)}
.time{font-size:11px;opacity:.6;margin-top:2px}
.msg img{display:block;max-width:72vw;border-radius:12px}

/* 入力行（Enterは改行／送信はボタン or Ctrl/Cmd+Enter） */
.inputRow{display:flex;gap:8px;padding:12px;background:#f6f8fc;border-top:1px solid rgba(2,6,23,.08);align-items:flex-end}
.textarea{flex:1;display:flex;flex-direction:column;gap:6px}
#text{width:100%;min-height:40px;max-height:36vh;resize:vertical;font-size:16px;padding:12px;border-radius:12px;border:1px solid rgba(2,6,23,.12);background:#fff}
.actions{display:flex;gap:8px}
.icon-btn, .send-btn{
  appearance:none;border:none;border-radius:12px;padding:10px 12px;background:#fff;border:1px solid rgba(2,6,23,.12);
  cursor:pointer;display:inline-flex;align-items:center;justify-content:center
}
.icon-btn .material-icons{font-size:22px;color:#0f172a}
.send-btn{background:#06c755;border-color:#06c755;color:#0b1b13;font-weight:700;gap:8px}
.send-btn[disabled], .icon-btn[disabled]{opacity:.6;cursor:not-allowed}

/* 送信ボタンのぐるぐる */
.btn-spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.6);border-top-color:#0b1b13;animation:sp 0.9s linear infinite}
</style>
</head>
<body>
<div class="header">
  <button class="back" id="backBtn">＜</button>
  <div style="min-width:0">
    <div class="title" id="peerName">読み込み中…</div>
    <div class="sub" id="peerSub"></div>
  </div>
  <div class="header-right">
    <a href="./contacts.html" title="チャット一覧"><span class="material-icons">chat</span></a>
    <span class="badge-dot" id="chatBadge"></span>
  </div>
</div>

<div id="prep" class="prep" role="status" aria-live="polite">トークルームを準備中…</div>
<div id="ready" class="ready" role="status" aria-live="polite">準備完了！</div>

<div id="loader" class="loader"><div class="spin"></div>読み込み中…</div>
<div id="chat" class="chat" aria-live="polite"></div>

<div class="inputRow">
  <div class="textarea">
    <textarea id="text" placeholder="メッセージを入力" autocomplete="off" disabled></textarea>
  </div>
  <div class="actions">
    <input type="file" id="pickImage" accept="image/*" hidden>
    <button id="btnImage" class="icon-btn" title="画像を送信" disabled><span class="material-icons">image</span></button>
    <button id="send" class="send-btn" disabled>送信</button>
  </div>
</div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxGxW7vYVhNejsGXEo0tTTzIz0pxu1uHrvWZH1fH83R8yVdC_9deFfpDS-xV2G4XQ2yCA/exec";

const $ = (id)=>document.getElementById(id);
const qs = new URLSearchParams(location.search);
const otherUserId = qs.get('other');

let me = { userId:null };
let roomId = null;
let since = null;
let pollTimer = null;
let sending = false;
let loading = false;
let newestReceived = null;  // 最新受信メッセージ時刻
const seen = new Set();     // 描画去重

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status)); return j;
}
function scrollBottom(){ const c = $('chat'); c.scrollTop = c.scrollHeight; }
function driveImageUrl(fileId){ return `https://lh3.googleusercontent.com/d/${fileId}`; }

/* メッセージ描画（画像マーカーを画像表示に変換） */
function renderMessages(items){
  if(!items || !items.length) return;
  const c = $('chat');
  let lastCreated = since;
  for(const m of items){
    const key = `${m.createdAt}|${m.fromUserId}|${m.text}`;
    if(seen.has(key)) continue;
    seen.add(key);

    const mine = (m.fromUserId === me.userId);
    const el = document.createElement('div');
    el.className = 'msg ' + (mine ? 'me' : 'them');

    const text = String(m.text||'');
    if(text.startsWith('[img:') && text.endsWith(']')){
      // 形式: [img:fileId|name|mime]
      const inner = text.slice(5,-1);
      const [fid, fname='image', mime='image/*'] = inner.split('|');
      const url = driveImageUrl(fid);
      el.innerHTML = `<img src="${url}" alt="${fname}" loading="lazy"><div class="time">${new Date(m.createdAt).toLocaleString()}</div>`;
    }else{
      const t = new Date(m.createdAt).toLocaleString();
      const safe = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
      el.innerHTML = `${safe}<div class="time">${t}</div>`;
    }

    c.appendChild(el);

    lastCreated = m.createdAt;
    if(!mine && m.toUserId === me.userId){
      if(!newestReceived || new Date(m.createdAt) > new Date(newestReceived)){
        newestReceived = m.createdAt;
      }
    }
  }
  if(lastCreated) since = lastCreated;
  scrollBottom();
}

async function loadOnce(showLoading=false){
  if(loading || !roomId) return;
  loading = true;
  try{
    if(showLoading){ $('loader').style.display='flex'; }
    const res = await callServer({ action:'history', idToken: liff.getIDToken(), roomId, since });
    renderMessages(res.messages || []);
    if(newestReceived){
      await callServer({ action:'markRead', idToken: liff.getIDToken(), roomId, at: newestReceived });
      newestReceived = null;
    }
  }catch(e){ console.error(e); }
  finally{ loading = false; $('loader').style.display='none'; }
}

async function startPolling(){
  if(pollTimer){ clearInterval(pollTimer); }
  await loadOnce(true);                   // 初回ロード（スピナー表示）
  // 準備完了：入力解放 & バナー切替
  enableInput(true);
  showReady();
  pollTimer = setInterval(loadOnce, 2000);
}

function enableInput(on){
  $('text').disabled = !on;
  $('send').disabled = !on;
  $('btnImage').disabled = !on;
  if(on){ $('text').focus(); }
}
function showReady(){
  const prep = $('prep'); if(prep) prep.style.display = 'none';
  const ready = $('ready'); if(ready){ ready.style.display = 'block'; setTimeout(()=> ready.style.display='none', 2000); }
}

/* 送信（テキスト） */
async function sendText(){
  if(sending) return;
  const input = $('text'); const btn = $('send');
  const text = input.value; // 改行保持
  if(!text.trim() || !roomId) return;

  const prevHtml = btn.innerHTML;
  try{
    sending = true; btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span><span>送信中…</span>';
    await callServer({ action:'send', idToken: liff.getIDToken(), roomId, text });
    input.value = '';
    await loadOnce(); // 反映
  }catch(e){
    alert('送信に失敗しました: ' + (e?.message || e));
  }finally{
    sending = false; btn.disabled = false; btn.innerHTML = '送信';
    input.focus();
  }
}

/* 送信（画像） */
function pickImage(){ $('pickImage').click(); }
$('btnImage').addEventListener('click', pickImage);
$('pickImage').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  if(!/^image\//.test(file.type)){ alert('画像ファイルを選択してください'); return; }
  if(!roomId){ alert('ルーム準備中です'); return; }

  const btn = $('send');
  const prevHtml = btn.innerHTML;
  try{
    // ぐるぐる
    btn.disabled = true; btn.innerHTML = '<span class="btn-spinner"></span><span>画像送信中…</span>';

    // Base64化（dataURL）
    const dataUrl = await new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });

    await callServer({
      action: 'sendImage',
      idToken: liff.getIDToken(),
      roomId,
      name: file.name || 'image',
      mime: file.type || 'image/*',
      dataUrl
    });
    // 直後に履歴反映
    await loadOnce();
  }catch(err){
    alert('画像送信に失敗しました: ' + (err?.message || err));
  }finally{
    btn.disabled = false; btn.innerHTML = '送信';
    e.target.value = ''; // 連続選択対策
  }
});

/* 入力系イベント */
$('send').addEventListener('click', sendText);
// Enterは改行、Ctrl/Cmd+Enterで送信
$('text').addEventListener('keydown', (e)=>{
  const isMac = /Mac|iPhone|iPad/.test(navigator.platform);
  if((isMac ? e.metaKey : e.ctrlKey) && e.key === 'Enter'){
    e.preventDefault(); sendText();
  }
});
$('backBtn').onclick = ()=>{ history.length > 1 ? history.back() : location.href='./contacts.html'; };
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') loadOnce(); });

/* ▼ ヘッダーの未読バッジ */
async function setupUnreadBadge(){
  const badge = $('chatBadge'); if(!badge) return;
  async function refresh(){
    try{
      const r = await callServer({ action:'unreadTotal', idToken: liff.getIDToken() });
      const n = Number(r.unread||0);
      if(n>0){ badge.textContent = n>99?'99+':n; badge.style.display='inline-block'; }
      else{ badge.style.display='none'; }
    }catch(e){}
  }
  await refresh();
  setInterval(refresh, 5000);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') refresh(); });
}

(async ()=>{
  if(!otherUserId){ alert('相手が指定されていません'); location.replace('./contacts.html'); return; }
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }

  const st = await callServer({ action:'status', idToken: liff.getIDToken() });
  if(!st.bound){ location.replace('./register.html'); return; }
  me.userId = st.userId;

  // 準備中表示
  enableInput(false);
  const prep = $('prep'); if(prep){ prep.textContent = 'トークルームを準備中…'; prep.style.display = 'block'; }

  const room = await callServer({ action:'room', idToken: liff.getIDToken(), otherUserId });
  roomId = room.roomId;
  const peer = room.peer || {};
  $('peerName').textContent = peer.name || 'ユーザー';
  $('peerSub').textContent  = (peer.store || '') + (peer.staffCode ? '・' + peer.staffCode : '');

  seen.clear(); since = null; $('chat').innerHTML = '';
  startPolling();

  setupUnreadBadge();
})();
</script>
</body>
</html>
