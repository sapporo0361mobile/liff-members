<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>トーク</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;display:flex;flex-direction:column}

/* ヘッダー */
.header{
  display:flex;align-items:center;gap:8px;
  padding:12px 12px;background:#fff;border-bottom:1px solid rgba(2,6,23,.08)
}
.back{appearance:none;border:none;background:none;font-size:16px;cursor:pointer;padding:8px}
.title{font-weight:800;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub{font-size:12px;opacity:.7}

/* 本文 */
.chat{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:80%;padding:8px 12px;border-radius:14px;word-break:break-word}
.me{align-self:flex-end;background:#dcfce7;border:1px solid rgba(2,6,23,.1)}
.them{align-self:flex-start;background:#fff;border:1px solid rgba(2,6,23,.12)}
.time{font-size:11px;opacity:.6;margin-top:2px}

/* 入力 */
.inputRow{
  display:flex;gap:8px;padding:12px;background:#f6f8fc;border-top:1px solid rgba(2,6,23,.08)
}
.inputRow input{flex:1;font-size:16px;padding:12px;border-radius:12px;border:1px solid rgba(2,6,23,.12);background:#fff}
.inputRow button{appearance:none;border:none;border-radius:12px;padding:12px 16px;background:#06c755;color:#0b1b13;font-weight:700;cursor:pointer}
.inputRow button[disabled]{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<!-- ヘッダー -->
<div class="header">
  <button class="back" id="backBtn">＜</button>
  <div style="min-width:0">
    <div class="title" id="peerName">読み込み中…</div>
    <div class="sub" id="peerSub"></div>
  </div>
</div>

<!-- メッセージ -->
<div id="chat" class="chat" aria-live="polite"></div>

<!-- 入力 -->
<div class="inputRow">
  <input id="text" placeholder="メッセージを入力" autocomplete="off" />
  <button id="send">送信</button>
</div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbz6LDVGyhdhedd9h_XWT9eQAxTPsx1TiNqtKBxe60YnJBXoajVQbjff47wDSZTxbqnxng/exec";

const $ = (id)=>document.getElementById(id);
const qs = new URLSearchParams(location.search);
const otherUserId = qs.get('other');

let me = { userId:null };
let roomId = null;
let since = null;
let pollTimer = null;
let sending = false; // ← 送信中フラグ（多重送信防止）

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

function scrollBottom(){ const c = $('chat'); c.scrollTop = c.scrollHeight; }

function renderMessages(items){
  const c = $('chat');
  items.forEach(m=>{
    const mine = (m.fromUserId === me.userId);
    const el = document.createElement('div');
    el.className = 'msg ' + (mine ? 'me' : 'them');
    const t = new Date(m.createdAt).toLocaleString();
    el.innerHTML = `${m.text}<div class="time">${t}</div>`;
    c.appendChild(el);
    since = m.createdAt;
  });
  scrollBottom();
}

async function loadOnce(){
  if(!roomId) return;
  const res = await callServer({ action:'history', idToken: liff.getIDToken(), roomId, since });
  renderMessages(res.messages || []);
}

async function startPolling(){
  if(pollTimer){ clearInterval(pollTimer); }
  await loadOnce();
  pollTimer = setInterval(loadOnce, 2000);
}

async function sendOnce(){
  if(sending) return; // 多重送信防止
  const input = $('text');
  const btn = $('send');
  const text = input.value.trim();
  if(!text || !roomId) return;

  try{
    sending = true;
    btn.disabled = true;
    await callServer({ action:'send', idToken: liff.getIDToken(), roomId, text });
    input.value = '';
    // ローカル即時反映はしない → サーバ送信完了後に最新履歴を取得
    await loadOnce();
  }catch(e){
    alert('送信に失敗しました: ' + (e?.message || e));
  }finally{
    sending = false;
    btn.disabled = false;
  }
}

$('send').addEventListener('click', sendOnce);
$('text').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendOnce();
  }
});
$('backBtn').onclick = ()=>{ history.length > 1 ? history.back() : location.href='./contacts.html'; };

(async ()=>{
  if(!otherUserId){ alert('相手が指定されていません'); location.replace('./contacts.html'); return; }

  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }

  // 自分確認
  const st = await callServer({ action:'status', idToken: liff.getIDToken() });
  if(!st.bound){ location.replace('./register.html'); return; }
  me.userId = st.userId;

  // ルーム確定 & 相手情報
  const room = await callServer({ action:'room', idToken: liff.getIDToken(), otherUserId });
  roomId = room.roomId;
  const peer = room.peer || {};
  $('peerName').textContent = peer.name || 'ユーザー';
  $('peerSub').textContent  = (peer.store || '') + (peer.staffCode ? '・' + peer.staffCode : '');

  // ポーリング開始
  startPolling();
})();
</script>
</body>
</html>
