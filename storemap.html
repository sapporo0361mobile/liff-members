<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>売場サーチ（3月棚卸時点）</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  :root{ --cell: 12px; --border: 1px; --border-color:#1f2937; }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;display:flex;flex-direction:column}

  .header{padding:14px 16px 8px;font-weight:800;font-size:18px}
  .container{flex:1;display:flex;flex-direction:column;gap:10px;padding:0 12px 16px;width:100%;max-width:100%}

  .view{position:relative;flex:0 0 auto;border:1px solid rgba(2,6,23,.08);border-radius:12px;background:#fff;overflow:hidden}
  .grid{display:grid;grid-template-columns:repeat(var(--cols),var(--cell));grid-auto-rows:var(--cell);width:100%}
  .cell{position:relative;overflow:hidden;line-height:1;user-select:none}
  .cell .label{
    position:absolute;left:2px;top:2px;font-size:10px;font-weight:700;
    padding:0 2px;border-radius:4px;max-width:100%;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    background:transparent; /*←色被りを避ける*/
    color:inherit;
    text-shadow:0 1px 2px rgba(0,0,0,.3), 0 0 2px rgba(255,255,255,.1);
  }
  .hit{outline:2px solid #22c55e;outline-offset:-2px;z-index:1}

  .search{display:flex;gap:8px;align-items:center;margin-top:10px}
  .search input{flex:1 1 auto;appearance:none;border:1px solid rgba(2,6,23,.1);background:#fff;border-radius:10px;padding:10px 12px;font-size:14px}
  .btn{appearance:none;border:none;background:#0f172a;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;display:inline-flex;gap:6px;align-items:center;height:40px}
  .btn.secondary{background:#e2e8f0;color:#0f172a}
  .loader{display:none;gap:8px;align-items:center;margin:4px 0 0 0;color:#334155;font-size:14px}
  .spin{width:16px;height:16px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:#06c755;animation:sp 1s linear infinite}
  @keyframes sp{to{transform:rotate(360deg)}}
  .status{font-size:12px;opacity:.7;margin-top:4px}
</style>
</head>
<body>
  <div class="header">売場サーチ（店内地図）</div>
  <div class="container">
    <div id="view" class="view" aria-label="店内地図ビュー">
      <div id="grid" class="grid" style="--cols:1"></div>
    </div>
    <div class="search">
      <input id="inputQuery" type="text" placeholder="JAN（13桁）">
      <button id="btnSearch" class="btn"><span class="material-icons">search</span>検索</button>
      <button id="btnClear" class="btn secondary"><span class="material-icons">backspace</span>クリア</button>
    </div>
    <div class="loader" id="loader"><div class="spin"></div><div>13732件の商品データを読み込んでいます…</div></div>
    <div class="status" id="status"></div>
  </div>

<script>
/* ==== 設定（差し替え） ==== */
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby7mwDBYMcYRpl3Xbdwx8TFCV5Kn8RK9vVmhHHJEM0yuRJbtiwlHJwMjkoUC-1sjBPyqg/exec";

/* ==== ユーティリティ ==== */
const $ = id => document.getElementById(id);
function rgbToCss(rgb){
  const r = Math.round((rgb?.red??1)*255);
  const g = Math.round((rgb?.green??1)*255);
  const b = Math.round((rgb?.blue??1)*255);
  const a = (typeof rgb?.alpha === 'number') ? rgb.alpha : 1;
  return (a < 1) ? `rgba(${r},${g},${b},${a.toFixed(3)})` : `rgb(${r},${g},${b})`;
}
const isDark = (rgb)=>{ const r=(rgb?.red??1),g=(rgb?.green??1),b=(rgb?.blue??1); return (0.2126*r+0.7152*g+0.0722*b)<0.5; };
async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status)); return j;
}

/* ==== 状態 ==== */
let current = { rows:0, cols:0, cells:{}, merges:[] };
let ownerMap = {};                 // 'r:c' -> 'anchorR:anchorC'
let spanMap  = {};                 // 'anchorR:anchorC' -> {rs, cs}
let elemMap  = {};                 // 'anchorR:anchorC' -> HTMLElement
let janIndex = {};                 // JAN -> [棚番,...]
let shelfToAnchors = new Map();    // 棚番 -> [anchorKey,...]

/* 横幅フィット（最小ズームで横いっぱい） */
function fitToWidth(){
  const view = $('view'); const cols = Math.max(1, current.cols||1);
  const w = view.clientWidth;
  const px = Math.max(2, Math.floor(w / cols));
  document.documentElement.style.setProperty('--cell', px+'px');
}

/* マージ情報をマップ化 */
function buildMergeMaps(){
  ownerMap = {}; spanMap = {};
  (current.merges||[]).forEach(m=>{
    const anchor = `${m.r}:${m.c}`;
    spanMap[anchor] = { rs:m.rs, cs:m.cs };
    for(let rr=m.r; rr<m.r+m.rs; rr++){
      for(let cc=m.c; cc<m.c+m.cs; cc++){
        ownerMap[`${rr}:${cc}`] = anchor;
      }
    }
  });
}

/* 描画（結合セルはアンカーのみ） */
function renderGrid(){
  const grid = $('grid'); grid.style.setProperty('--cols', String(current.cols||1)); grid.innerHTML='';
  elemMap = {};
  const frag = document.createDocumentFragment();
  const rows = current.rows||0, cols = current.cols||0, cells = current.cells||{};

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const key = `${r}:${c}`;
      const owner = ownerMap[key];
      if(owner && owner !== key) continue;

      const d = cells[key] || null;
      const div = document.createElement('div');
      div.className = 'cell';
      div.dataset.r = r; div.dataset.c = c;

      const bg = d?.bg || {red:1,green:1,blue:1};
      div.style.background = rgbToCss(bg);

      const b = d?.b || {};
      div.style.borderTop    = (b.t ? `var(--border) solid var(--border-color)` : 'none');
      div.style.borderRight  = (b.r ? `var(--border) solid var(--border-color)` : 'none');
      div.style.borderBottom = (b.b ? `var(--border) solid var(--border-color)` : 'none');
      div.style.borderLeft   = (b.l ? `var(--border) solid var(--border-color)` : 'none');

      const sp = spanMap[key];
      if(sp){ div.style.gridColumn = `span ${sp.cs}`; div.style.gridRow = `span ${sp.rs}`; }

      if(d && (d.v || d.n)){
        const span = document.createElement('span');
        span.className = 'label';
        // 背景は透明、色は親の contrast をそのまま使う（isDarkで文字色を決めない）
        span.style.color = isDark(bg) ? '#fff' : '#0f172a';
        span.textContent = String(d.v || d.n || '');
        div.appendChild(span);
      }
      frag.appendChild(div);
      elemMap[key] = div;
    }
  }
  grid.appendChild(frag);
  fitToWidth();
}

/* 棚番 → アンカー要素の索引を構築 */
function buildShelfIndex(){
  shelfToAnchors = new Map();
  const cells = current.cells || {};
  const seen = new Set();
  Object.entries(cells).forEach(([key,d])=>{
    const [r,c] = key.split(':').map(Number);
    const v = String(d.v||'').trim();
    if(!/^\d+$/.test(v)) return;
    const anchor = ownerMap[key] || key;
    if(seen.has(anchor)) return;
    seen.add(anchor);
    const list = shelfToAnchors.get(v) || [];
    list.push(anchor);
    shelfToAnchors.set(v, list);
  });
}

/* ハイライト制御 */
function clearHits(){ document.querySelectorAll('.cell.hit').forEach(el=>el.classList.remove('hit')); }
function highlightAnchors(anchorKeys){
  clearHits();
  let first = null;
  (anchorKeys||[]).forEach(k=>{
    const el = elemMap[k];
    if(el){
      el.classList.add('hit');
      if(!first) first = el;
    }
  });
  if(first) first.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
}

/* === JAN（13桁）検索: ローカル索引のみで即時 === */
function searchByJanLocal(jan){
  const shelves = janIndex[jan] || [];
  if(!shelves.length){
    $('status').textContent = `JAN ${jan} は見つかりません`;
    clearHits();
    return;
  }
  const anchors = [];
  shelves.forEach(s=>{
    const list = shelfToAnchors.get(String(s)) || [];
    anchors.push(...list);
  });
  if(!anchors.length){
    $('status').textContent = `棚番は見つかったが、Floor1 上に一致セルがありません: ${shelves.join(', ')}`;
    clearHits();
    return;
  }
  highlightAnchors(anchors);
  $('status').textContent = `JAN ${jan} → 棚番 ${shelves.join(', ')} を表示`;
}

/* 文字検索（セル値/ノート） */
function searchText(q){
  clearHits();
  const cells = current.cells || {};
  let first = null, count = 0, marked = new Set();
  Object.entries(cells).forEach(([key,d])=>{
    const [r,c] = key.split(':').map(Number);
    const txt = (d.v||'') + ' ' + (d.n||'');
    if(!txt || !txt.toLowerCase().includes(q.toLowerCase())) return;
    const anchor = ownerMap[key] || key;
    if(marked.has(anchor)) return;
    marked.add(anchor);
    const el = elemMap[anchor];
    if(el){
      el.classList.add('hit'); count++;
      if(!first) first = el;
    }
  });
  if(first) first.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
  $('status').textContent = count ? `検索ヒット: ${count} 件` : '該当なし';
}

/* ==== 初期読み込み（地図 + JAN索引） ==== */
async function initLoad(){
  try{
    $('loader').style.display='flex'; $('status').textContent = '';
    let res = await callServer({ action:'initBundle', idToken:liff.getIDToken() });
    if(!res.ok && /unknown action/i.test(res.error||'')){
      // フォールバック（古いGAS用）
      const mapRes = await callServer({ action:'storeMap', idToken:liff.getIDToken() });
      if(!mapRes.ok) throw new Error(mapRes.error||'storeMap failed');
      let idxRes = await callServer({ action:'dataIndex', idToken:liff.getIDToken() }).catch(()=>null);
      res = { ok:true, map: mapRes, index: (idxRes&&idxRes.ok)? idxRes.index : {}, janCount: (idxRes&&idxRes.ok)? idxRes.count : 0 };
    }
    if(!res.ok) throw new Error(res.error||'init failed');

    const m = res.map || {};
    current = { rows:+(m.rows||0), cols:+(m.cols||0), cells:m.cells||{}, merges:m.merges||[] };
    janIndex = res.index || {};

    buildMergeMaps();
    renderGrid();
    buildShelfIndex();
    $('status').textContent = `初期読込完了（JAN: ${res.janCount||0} 件）`;
  }catch(e){
    console.error(e);
    $('status').textContent = '初期読み込みに失敗: ' + (e?.message||e);
    alert('初期読み込みに失敗しました：' + (e?.message || e));
  }finally{
    $('loader').style.display='none';
  }
}

/* ==== 初期化・イベント ==== */
(async ()=>{
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  await initLoad();
})();
$('btnSearch').addEventListener('click', ()=>{
  const q = $('inputQuery').value.trim();
  if(/^\d{13}$/.test(q)) searchByJanLocal(q);
  else searchText(q);
});
$('inputQuery').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const q = $('inputQuery').value.trim();
    if(/^\d{13}$/.test(q)) searchByJanLocal(q);
    else searchText(q);
  }
});
$('btnClear').addEventListener('click', ()=>{ $('inputQuery').value=''; clearHits(); $('status').textContent=''; });
window.addEventListener('resize', ()=>{ if(current.cols) fitToWidth(); });
</script>
</body>
</html>
