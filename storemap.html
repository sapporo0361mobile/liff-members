<!doctype html>
<html lang="ja">
<head>
  <!-- ① LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- ② あなたの LIFF ID を設定 -->
  <script>window.LIFF_ID = "2007972627-vnAq4qbB";</script>

  <!-- ③ LINEアプリ外ブロック用ガード：すべてのHTMLで共通に貼る -->
  <style id="liff-guard-style">body{display:none!important}</style>
  <script>
  (function(){
    var LIFF_ID = window.LIFF_ID || "";
    function allow(){
      var st=document.getElementById('liff-guard-style'); if(st) st.remove();
      if(document.body) document.body.style.display='';
    }
    function block(){
      var deeplink = LIFF_ID ? ('https://liff.line.me/' + encodeURIComponent(LIFF_ID)) : '';
      document.open();
      document.write(
        '<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
        '<title>このページはLINEアプリ専用です</title>'+
        '<style>html,body{height:100%}body{margin:0;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Arial}'+
        '.card{max-width:720px;margin:0 16px;background:#111827;border-radius:14px;padding:18px 16px;border:1px solid rgba(255,255,255,.08)}'+
        '.h{font-weight:800;margin:4px 0 8px;font-size:16px}.p{opacity:.9;line-height:1.6;font-size:14px}'+
        '.btn{margin-top:12px;display:inline-block;background:#06c755;color:#0b2314;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:700}'+
        '</style>'+
        '<div class="card">'+
          '<div class="h">このページは LINE アプリ内でのみ利用できます</div>'+
          '<div class="p">LINE のトーク、または <b>ホーム → サービス</b> から開き直してください。</div>' +
          (deeplink ? '<a class="btn" href="'+deeplink+'">LINEで開く</a>' : '')+
        '</div>'
      );
      document.close();
    }
    function uaLooksLikeLine(){
      var ua = navigator.userAgent || '';
      return /Line\/|LIFF/i.test(ua);
    }
    if(!window.liff){
      if(uaLooksLikeLine()){ allow(); } else { block(); }
      return;
    }
    liff.init({ liffId: LIFF_ID }).then(function(){
      if(liff.isInClient()){ allow(); } else { block(); }
    }).catch(function(){
      if(uaLooksLikeLine()){ allow(); } else { block(); }
    });
  })();
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>売場サーチ</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root{ --cell: 12px; --border: 1px; --border-color:#1f2937; }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:#f6f8fc;color:#0f172a;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;
      display:flex;flex-direction:column
    }
    .header{padding:14px 16px 8px;font-weight:800;font-size:18px}
    .container{flex:1;display:flex;flex-direction:column;gap:10px;padding:0 12px 16px;width:100%;max-width:100%}

    .view{position:relative;flex:0 0 auto;border:1px solid rgba(2,6,23,.08);border-radius:12px;background:#fff;overflow:hidden}
    .grid{display:grid;grid-template-columns:repeat(var(--cols),var(--cell));grid-auto-rows:var(--cell);width:100%}
    .cell{position:relative;overflow:hidden;line-height:1;user-select:none}
    .hit{outline:2px solid #ef4444;outline-offset:-2px;z-index:1;box-shadow:0 0 0 2px rgba(239,68,68,.35) inset}

    /* 検索＋カメラ（縦積み） */
    .search{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .search .row{display:flex;gap:8px;align-items:center}
    .search input{flex:1 1 auto;appearance:none;border:1px solid rgba(2,6,23,.1);background:#fff;border-radius:10px;padding:10px 12px;font-size:14px}
    .btn{appearance:none;border:none;background:#0f172a;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;display:inline-flex;gap:6px;align-items:center;height:40px}
    .btn.secondary{background:#e2e8f0;color:#0f172a}
    .btn.block{width:100%;justify-content:center}

    .loader{display:none;gap:8px;align-items:center;margin:4px 0 0 0;color:#334155;font-size:14px}
    .spin{width:16px;height:16px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:#06c755;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .status{font-size:12px;opacity:.7;margin-top:4px}

    /* 進捗バー（％＋ゲージ） */
    .progress{position:relative;height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden;margin:4px 0 0 0;display:none}
    .progress .bar{position:absolute;left:0;top:0;height:100%;width:0%;background:#06c755;transition:width .12s linear}
    .progress-text{font-size:12px;opacity:.7;margin-top:6px;text-align:right}

    /* スキャナーモーダル */
    .scanner-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .scanner{background:#000;border-radius:14px;overflow:hidden;max-width:520px;width:92vw}
    .scanner header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#0f172a;color:#fff}
    .scanner video{width:100%;height:auto;background:#000}
    .scanner .footer{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#0f172a;color:#fff}
    .scanner .tag{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="header">売場サーチ（Fast v3, 2025年3月棚卸時点）</div>
  <div class="container">
    <div id="view" class="view" aria-label="店内地図ビュー">
      <div id="grid" class="grid" style="--cols:1"></div>
    </div>

    <!-- 検索（1段目）＋ カメラ（2段目） -->
    <div class="search">
      <div class="row">
        <input id="inputQuery" type="text" inputmode="numeric" placeholder="JAN（13桁）">
        <button id="btnSearch" class="btn"><span class="material-icons">search</span>検索</button>
        <button id="btnClear" class="btn secondary"><span class="material-icons">backspace</span>クリア</button>
      </div>
      <button id="btnScan" class="btn secondary block"><span class="material-icons">photo_camera</span>カメラでJANを読み取る</button>
    </div>

    <div class="loader" id="loader"><div class="spin"></div><div>読み込み中…</div></div>
    <div class="progress" id="progress" aria-hidden="true"><div class="bar" id="progressBar"></div></div>
    <div class="progress-text" id="progressText">0%</div>
    <div class="status" id="status"></div>

    <!-- スキャナーUI -->
    <div id="scannerModal" class="scanner-backdrop" role="dialog" aria-modal="true" aria-label="バーコードスキャナー">
      <div class="scanner">
        <header>
          <div style="display:flex;align-items:center;gap:8px"><span class="material-icons">qr_code_scanner</span><strong>JANスキャナー</strong></div>
          <button id="btnScannerClose" class="btn secondary" style="height:32px;padding:6px 10px"><span class="material-icons">close</span>閉じる</button>
        </header>
        <video id="scannerVideo" autoplay playsinline muted></video>
        <div class="footer">
          <span class="material-icons">tips_and_updates</span>
          <div class="tag">枠内にバーコード（JAN/EAN-13）を合わせてください</div>
        </div>
      </div>
    </div>
  </div>

<script>
/***** 設定（差し替え） *****/
const LIFF_ID      = "2007972627-vnAq4qbB"; // ←自分のLIFF ID
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwKFeF3xU86ha9B17M1hkagA44EXJCejGFmptKxIQAQMAVycIvklspNp5OpZuF0ixnMnA/exec"; // ←GASのWebアプリURL

/***** ユーティリティ *****/
const $ = id => document.getElementById(id);
function rgbToCss(g){
  if(!g) return 'rgb(255,255,255)';
  const r = (typeof g.r==='number')? g.r : 255;
  const gg= (typeof g.g==='number')? g.g : 255;
  const b = (typeof g.b==='number')? g.b : 255;
  const a = (typeof g.a==='number')? g.a : 1;
  return (a<1) ? `rgba(${r},${gg},${b},${a.toFixed(3)})` : `rgb(${r},${gg},${b})`;
}
async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status)); return j;
}

/***** 進捗（なめらか補間＋自動前進） *****/
let _pNow = 0, _pTarget = 0, _pTimer = null, _pAuto = null;
function _tick(){
  const step = Math.max(0.2, (_pTarget - _pNow) * 0.18);
  _pNow = Math.min(_pTarget, _pNow + step);
  const pct = Math.floor(_pNow);
  const bar = $('progressBar');
  const txt = $('progressText');
  if(bar) bar.style.width = pct + '%';
  if(txt) txt.textContent = pct + '%';
  if (Math.abs(_pTarget - _pNow) < 0.5 && _pTarget >= 100){ stopProgress(); }
}
function showProgress(){
  const p = $('progress'); if(!p) return;
  p.style.display='block'; p.setAttribute('aria-hidden','false');
  if(_pTimer) cancelAnimationFrame(_pTimer);
  _pTimer = requestAnimationFrame(function loop(){ _tick(); _pTimer = requestAnimationFrame(loop); });
  clearInterval(_pAuto);
  _pAuto = setInterval(()=>{ if(_pTarget < 95) setProgressTarget(_pTarget + 1); }, 450);
}
function hideProgress(){
  const p = $('progress'); if(!p) return;
  p.style.display='none'; p.setAttribute('aria-hidden','true');
  $('progressBar').style.width='0%'; $('progressText').textContent='0%';
  _pNow = 0; _pTarget = 0;
  if(_pTimer) cancelAnimationFrame(_pTimer), _pTimer=null;
  clearInterval(_pAuto); _pAuto=null;
}
function startProgress(){ _pNow=0; _pTarget=0; showProgress(); setProgressTarget(3); }
function setProgressTarget(v){ _pTarget = Math.max(_pTarget, Math.min(100, v|0)); }
function stopProgress(){ _pTarget = 100; setTimeout(hideProgress, 500); }

/***** 状態 *****/
let current = { rows:0, cols:0, cells:{}, merges:[] };
let ownerMap = {};
let spanMap  = {};
let elemMap  = {};
let janIndex = {};
let shelfToAnchors = new Map();

/***** レイアウト系 *****/
function fitToWidth(){
  const view = $('view'); const cols = Math.max(1, current.cols||1);
  const px = Math.max(2, Math.floor(view.clientWidth / cols));
  document.documentElement.style.setProperty('--cell', px+'px');
}
function buildMergeMaps(){
  ownerMap = {}; spanMap = {};
  (current.merges||[]).forEach(m=>{
    const anchor = `${m.r}:${m.c}`;
    spanMap[anchor] = { rs:m.rs, cs:m.cs };
    for(let rr=m.r; rr<m.r+m.rs; rr++){
      for(let cc=m.c; cc<m.c+m.cs; cc++){
        ownerMap[`${rr}:${cc}`] = anchor;
      }
    }
  });
}
function renderGrid(){
  const grid = $('grid'); grid.style.setProperty('--cols', String(current.cols||1)); grid.innerHTML='';
  elemMap = {};
  const frag = document.createDocumentFragment();
  const rows = current.rows||0, cols = current.cols||0, cells = current.cells||{};
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const key = `${r}:${c}`;
      const owner = ownerMap[key];
      if(owner && owner !== key) continue;

      const d = cells[key] || null;
      const div = document.createElement('div');
      div.className = 'cell';
      div.dataset.r = r; div.dataset.c = c;

      div.style.background = rgbToCss(d?.g);
      const b = d?.b || {};
      div.style.borderTop    = (b.t ? `var(--border) solid var(--border-color)` : 'none');
      div.style.borderRight  = (b.r ? `var(--border) solid var(--border-color)` : 'none');
      div.style.borderBottom = (b.b ? `var(--border) solid var(--border-color)` : 'none');
      div.style.borderLeft   = (b.l ? `var(--border) solid var(--border-color)` : 'none');

      const sp = spanMap[key];
      if(sp){ div.style.gridColumn = `span ${sp.cs}`; div.style.gridRow = `span ${sp.rs}`; }

      frag.appendChild(div);
      elemMap[key] = div;
    }
  }
  grid.appendChild(frag);
  fitToWidth();
}

/***** 索引 *****/
function buildShelfIndex(){
  shelfToAnchors = new Map();
  const cells = current.cells || {};
  const seen = new Set();
  Object.entries(cells).forEach(([key,d])=>{
    const v = String(d.v||'').trim();
    if(!/^\d+$/.test(v)) return;
    const anchor = ownerMap[key] || key;
    if(seen.has(anchor)) return;
    seen.add(anchor);
    const list = shelfToAnchors.get(v) || [];
    list.push(anchor);
    shelfToAnchors.set(v, list);
  });
}

/***** ハイライト *****/
function clearHits(){ document.querySelectorAll('.cell.hit').forEach(el=>el.classList.remove('hit')); }
function highlightAnchors(anchorKeys){
  clearHits();
  let first = null;
  (anchorKeys||[]).forEach(k=>{
    const el = elemMap[k];
    if(el){ el.classList.add('hit'); if(!first) first = el; }
  });
  if(first) first.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
}

/***** 検索 *****/
function searchByJanLocal(jan){
  const shelves = janIndex[jan] || [];
  if(!shelves.length){ $('status').textContent = `JAN ${jan} は見つかりません`; clearHits(); return; }
  const anchors = [];
  shelves.forEach(s=>{ const list = shelfToAnchors.get(String(s)) || []; anchors.push(...list); });
  if(!anchors.length){ $('status').textContent = `棚番は見つかったが Floor1 に一致セルがありません: ${shelves.join(', ')}`; clearHits(); return; }
  highlightAnchors(anchors);
  $('status').textContent = `JAN ${jan} → 棚番 ${shelves.join(', ')} を表示`;
}
function searchText(q){
  clearHits();
  const cells = current.cells || {};
  let first = null, count = 0, marked = new Set();
  Object.entries(cells).forEach(([key,d])=>{
    const txt = (d.v||'') + ' ' + (d.n||'');
    if(!txt || !txt.toLowerCase().includes(q.toLowerCase())) return;
    const anchor = ownerMap[key] || key;
    if(marked.has(anchor)) return;
    marked.add(anchor);
    const el = elemMap[anchor];
    if(el){ el.classList.add('hit'); count++; if(!first) first = el; }
  });
  if(first) first.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
  $('status').textContent = count ? `検索ヒット: ${count} 件` : '該当なし';
}

/***** 初期読み込み（段階的に進捗更新） *****/
async function initLoad(){
  try{
    $('loader').style.display='flex'; $('status').textContent = '';
    startProgress();
    setProgressTarget(8);

    const idToken = liff.getIDToken();
    setProgressTarget(15);
    setProgressTarget(25);

    let res = await callServer({ action:'initBundle', idToken }).catch(e=>({ok:false,error:String(e)}));
    if(!res.ok && /unknown action/i.test(res.error||'')){
      setProgressTarget(35);
      const mapRes = await callServer({ action:'storeMap', idToken });
      if(!mapRes.ok) throw new Error(mapRes.error||'storeMap failed');
      setProgressTarget(45);
      let idxRes = await callServer({ action:'dataIndex', idToken }).catch(()=>null);
      res = { ok:true, map: mapRes, index: (idxRes&&idxRes.ok)? idxRes.index : {}, janCount: (idxRes&&idxRes.ok)? idxRes.count : 0 };
    }
    if(!res.ok) throw new Error(res.error||'init failed');

    setProgressTarget(55);
    const m = res.map || {};
    current = { rows:+(m.rows||0), cols:+(m.cols||0), cells:m.cells||{}, merges:m.merges||[] };

    setProgressTarget(65);
    buildMergeMaps();
    setProgressTarget(75);
    renderGrid();

    setProgressTarget(85);
    janIndex = res.index || {};
    buildShelfIndex();

    setProgressTarget(100);
    $('status').textContent = `初期読込完了（JAN: ${res.janCount||0} 件${res.cacheKey?`, cache:${res.cacheKey}`:''}）`;
  }catch(e){
    console.error(e);
    $('status').textContent = '初期読み込みに失敗: ' + (e?.message||e);
    alert('初期読み込みに失敗しました：' + (e?.message || e));
    hideProgress();
  }finally{
    $('loader').style.display='none';
  }
}

/***** 初期化・イベント *****/
(async ()=>{
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  await initLoad();
})();
$('btnSearch').addEventListener('click', ()=>{
  const q = $('inputQuery').value.trim();
  if(/^\d{13}$/.test(q)) searchByJanLocal(q); else searchText(q);
});
$('inputQuery').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const q = $('inputQuery').value.trim();
    if(/^\d{13}$/.test(q)) searchByJanLocal(q); else searchText(q);
  }
});
$('btnClear').addEventListener('click', ()=>{ $('inputQuery').value=''; clearHits(); $('status').textContent=''; });
window.addEventListener('resize', ()=>{ if(current.cols) fitToWidth(); });

/* ===== バーコードスキャナー（テストツールの起動方式を流用） ===== */
let mediaStream = null;
let scanning = false;

/* フォールバック付きで getUserMedia を段階的に試す */
async function startScanner(){
  try{
    // モーダルを先に開く（iOSでの再生許可を安定させる）
    $('#scannerModal').style.display='flex';

    // ★段階的フォールバック（テストツールの「背面で起動」に合わせた順序）
    const plans = [
      { audio:false, video:{ facingMode:{ ideal:'environment' } } },        // 1) 端末任せで背面
      { audio:false, video:true }                                            // 2) さらにゆるく
    ];

    let lastErr = null;
    for(const cons of plans){
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia(cons);
        const video = $('#scannerVideo');
        video.setAttribute('playsinline',''); // iOS対策
        video.muted = true;
        video.srcObject = mediaStream;
        await video.play();
        scanning = true;
        return; // 起動成功
      }catch(e){
        lastErr = e;
        // 次のプランへフォールバック
      }
    }

    // すべて失敗した場合
    const name = lastErr && (lastErr.name || lastErr.message) || String(lastErr);
    let hint = '';
    if(/NotAllowedError|Permission/i.test(name)) hint = '\n\nカメラ権限が拒否されています。端末設定でLINEのカメラを許可してください。';
    else if(/NotFoundError|DevicesNotFound/i.test(name)) hint = '\n\nカメラが見つかりません。別端末でお試しください。';
    else if(/OverconstrainedError|Constraint/i.test(name)) hint = '\n\n指定の解像度/FPSが未対応です。制約を外して再試行してください。';
    else if(/SecureContext|https/i.test(name)) hint = '\n\nページは https:// で提供されている必要があります。';
    throw new Error(name + hint);

  }catch(e){
    stopScanner();
    alert('カメラを開始できませんでした: ' + (e?.message || e));
  }
}

function stopScanner(){
  scanning = false;
  try{ if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); } }catch(_){}
  mediaStream = null;
  $('#scannerModal').style.display='none';
}

/* 読み取り結果（今はカメラ起動確認目的。JANデコードを後で差す想定） */
function onScanResult(jan){
  stopScanner();
  $('#inputQuery').value = jan;
  searchByJanLocal(jan);
}

/* ボタン */
$('btnScan').addEventListener('click', startScanner);
$('btnScannerClose').addEventListener('click', stopScanner);
</script>
</body>
</html>
