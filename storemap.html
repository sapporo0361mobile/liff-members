<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>売場サーチ（Fast v3 + Html5Qrcode + Progress）</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  :root{ --cell: 12px; --border: 1px; --border-color:#1f2937; }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:#f6f8fc;color:#0f172a;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;
    display:flex;flex-direction:column
  }
  .header{padding:14px 16px 8px;font-weight:800;font-size:18px}
  .container{flex:1;display:flex;flex-direction:column;gap:10px;padding:0 12px 16px;width:100%;max-width:100%}

  .view{position:relative;flex:0 0 auto;border:1px solid rgba(2,6,23,.08);border-radius:12px;background:#fff;overflow:hidden}
  .grid{display:grid;grid-template-columns:repeat(var(--cols),var(--cell));grid-auto-rows:var(--cell);width:100%}
  .cell{position:relative;overflow:hidden;line-height:1;user-select:none}
  .hit{outline:2px solid #ef4444;outline-offset:-2px;z-index:1;box-shadow:0 0 0 2px rgba(239,68,68,.35) inset}

  /* 検索＋カメラ（縦積み） */
  .search{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .search .row{display:flex;gap:8px;align-items:center}
  .search input{flex:1 1 auto;appearance:none;border:1px solid rgba(2,6,23,.1);background:#fff;border-radius:10px;padding:10px 12px;font-size:14px}
  .btn{appearance:none;border:none;background:#0f172a;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;display:inline-flex;gap:6px;align-items:center;height:40px}
  .btn.secondary{background:#e2e8f0;color:#0f172a}
  .btn.block{width:100%;justify-content:center}

  .loader{display:none;gap:8px;align-items:center;margin:4px 0 0 0;color:#334155;font-size:14px}
  .spin{width:16px;height:16px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:#06c755;animation:sp 1s linear infinite}
  @keyframes sp{to{transform:rotate(360deg)}}
  .status{font-size:12px;opacity:.7;margin-top:4px}

  /* 進捗バー（％＋ゲージ） */
  .progress{position:relative;height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden;margin:4px 0 0 0;display:none}
  .progress .bar{position:absolute;left:0;top:0;height:100%;width:0%;background:#06c755;transition:width .12s linear}
  .progress-text{font-size:12px;opacity:.7;margin-top:6px;text-align:right}

  /* スキャナーモーダル（ライブ or 画像） */
  .scanner-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .scanner{background:#0f172a;border-radius:14px;overflow:hidden;max-width:560px;width:94vw;color:#fff}
  .scanner header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:#0b1220}
  .scanner .body{background:#000;display:flex;flex-direction:column;gap:8px;padding:8px}
  .scanner .body > *{background:#000}
  .scanner .footer{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#0b1220}
  .scanner .tag{font-size:12px;opacity:.85}
  .scanner .alt{display:flex;flex-direction:column;gap:8px;padding:8px;color:#e2e8f0;background:#0b1220}
  .scanner input[type=file]{background:#fff;color:#0f172a;border-radius:10px;padding:10px 12px;border:none}
  #reader{width:100%;min-height:260px}

  /* プレビュー（根本確認用） */
  .preview-wrap{display:none;flex-direction:column;gap:8px;padding:8px;background:#0b1220}
  .preview-wrap video{width:100%;max-height:260px;background:#000;border-radius:10px}
  .note{font-size:12px;opacity:.75}
</style>
</head>
<body>
  <div class="header">売場サーチ（Fast v3, 2025年3月棚卸時点）</div>
  <div class="container">
    <div id="view" class="view" aria-label="店内地図ビュー">
      <div id="grid" class="grid" style="--cols:1"></div>
    </div>

    <!-- 検索（1段目）＋ カメラ（2段目） -->
    <div class="search">
      <div class="row">
        <input id="inputQuery" type="text" inputmode="numeric" placeholder="JAN（13桁）またはキーワード">
        <button id="btnSearch" class="btn"><span class="material-icons">search</span>検索</button>
        <button id="btnClear" class="btn secondary"><span class="material-icons">backspace</span>クリア</button>
      </div>
      <button id="btnScan" class="btn secondary block"><span class="material-icons">photo_camera</span>カメラでJANを読み取る</button>
    </div>

    <div class="loader" id="loader"><div class="spin"></div><div>読み込み中…</div></div>
    <div class="progress" id="progress" aria-hidden="true"><div class="bar" id="progressBar"></div></div>
    <div class="progress-text" id="progressText">0%</div>
    <div class="status" id="status"></div>

    <!-- スキャナーUI（ライブ＆フォールバック） -->
    <div id="scannerModal" class="scanner-backdrop" role="dialog" aria-modal="true" aria-label="バーコードスキャナー">
      <div class="scanner">
        <header>
          <div style="display:flex;align-items:center;gap:8px"><span class="material-icons">qr_code_scanner</span><strong>JANスキャナー</strong></div>
          <button id="btnScannerClose" class="btn secondary" style="height:32px;padding:6px 10px"><span class="material-icons">close</span>閉じる</button>
        </header>
        <div class="body">
          <!-- ライブ読み取りビュー（Html5Qrcode が入る場所） -->
          <div id="reader"></div>
        </div>

        <!-- 根本確認：getUserMedia プレビュー -->
        <div class="preview-wrap" id="previewWrap">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnPreviewStart" class="btn secondary" style="height:36px"><span class="material-icons">videocam</span>カメラをテスト起動</button>
            <button id="btnPreviewStop" class="btn secondary" style="height:36px"><span class="material-icons">stop</span>プレビュー停止</button>
          </div>
          <video id="previewVideo" autoplay playsinline muted></video>
          <div id="previewMsg" class="note"></div>
          <div class="note">※ ここでプレビューが映れば、権限とデバイスは正常です。その後「ライブ読み取り」を開始します。</div>
        </div>

        <div class="alt">
          <div class="tag">ライブカメラが使えない場合は、写真から読み取れます。</div>
          <input id="fileInput" type="file" accept="image/*" capture="environment">
        </div>
        <div class="footer">
          <span class="material-icons">tips_and_updates</span>
          <div class="tag">バーコード（JAN/EAN-13）を枠に合わせるか、写真を選択してください。</div>
        </div>
      </div>
    </div>
  </div>

<script>
/***** 設定（差し替え） *****/
const LIFF_ID      = "2007972627-vnAq4qbB"; // ←自分のLIFF ID
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwKFeF3xU86ha9B17M1hkagA44EXJCejGFmptKxIQAQMAVycIvklspNp5OpZuF0ixnMnA/exec"; // ←GASのWebアプリURL

/***** ユーティリティ *****/
const $ = id => document.getElementById(id);
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=()=>rej(new Error('load failed: '+src)); document.head.appendChild(s); }); }
function rgbToCss(g){ if(!g) return 'rgb(255,255,255)'; const r=(typeof g.r==='number')?g.r:255, gg=(typeof g.g==='number')?g.g:255, b=(typeof g.b==='number')?g.b:255, a=(typeof g.a==='number')?g.a:1; return (a<1)?`rgba(${r},${gg},${b},${a.toFixed(3)})`:`rgb(${r},${gg},${b})`; }
async function callServer(payload){ const r=await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)}); const t=await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} } if(!r.ok||!j.ok) throw new Error(j.error||("HTTP "+r.status)); return j; }

/***** 進捗（スムーズ） *****/
let _pNow=0,_pTarget=0,_pTimer=null,_pAuto=null;
function _tick(){ const step=Math.max(0.2,(_pTarget-_pNow)*0.18); _pNow=Math.min(_pTarget,_pNow+step); const pct=Math.floor(_pNow); $('progressBar').style.width=pct+'%'; $('progressText').textContent=pct+'%'; if(Math.abs(_pTarget-_pNow)<0.5&&_pTarget>=100){ stopProgress(); } }
function showProgress(){ $('progress').style.display='block'; $('progress').setAttribute('aria-hidden','false'); if(_pTimer) cancelAnimationFrame(_pTimer); _pTimer=requestAnimationFrame(function loop(){ _tick(); _pTimer=requestAnimationFrame(loop); }); clearInterval(_pAuto); _pAuto=setInterval(()=>{ if(_pTarget<95)_pTarget++; }, 450); }
function hideProgress(){ $('progress').style.display='none'; $('progress').setAttribute('aria-hidden','true'); $('progressBar').style.width='0%'; $('progressText').textContent='0%'; _pNow=0; _pTarget=0; if(_pTimer) cancelAnimationFrame(_pTimer),_pTimer=null; clearInterval(_pAuto); _pAuto=null; }
function startProgress(){ _pNow=0; _pTarget=3; showProgress(); }
function setProgressTarget(v){ _pTarget = Math.max(_pTarget, Math.min(100, v|0)); }
function stopProgress(){ _pTarget=100; setTimeout(hideProgress,600); }

/***** 状態 *****/
let current={rows:0,cols:0,cells:{},merges:[]}; let ownerMap={},spanMap={},elemMap={},janIndex={},shelfToAnchors=new Map();

/***** レイアウト（完全実装） *****/
function fitToWidth(){ const view=$('view'); const cols=Math.max(1,current.cols||1); const px=Math.max(2,Math.floor(view.clientWidth/cols)); document.documentElement.style.setProperty('--cell',px+'px'); }
function buildMergeMaps(){ ownerMap={}; spanMap={}; (current.merges||[]).forEach(m=>{ const anchor=`${m.r}:${m.c}`; spanMap[anchor]={rs:m.rs, cs:m.cs}; for(let rr=m.r; rr<m.r+m.rs; rr++){ for(let cc=m.c; cc<m.c+m.cs; cc++){ ownerMap[`${rr}:${cc}`]=anchor; } } }); }
function renderGrid(){ const grid=$('grid'); grid.style.setProperty('--cols', String(current.cols||1)); grid.innerHTML=''; elemMap={}; const frag=document.createDocumentFragment(); const rows=current.rows||0, cols=current.cols||0, cells=current.cells||{}; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const key=`${r}:${c}`; const owner=ownerMap[key]; if(owner && owner!==key) continue; const d=cells[key]||null; const div=document.createElement('div'); div.className='cell'; div.dataset.r=r; div.dataset.c=c; div.style.background=rgbToCss(d?.g); const b=d?.b||{}; div.style.borderTop=(b.t?`var(--border) solid var(--border-color)`:'none'); div.style.borderRight=(b.r?`var(--border) solid var(--border-color)`:'none'); div.style.borderBottom=(b.b?`var(--border) solid var(--border-color)`:'none'); div.style.borderLeft=(b.l?`var(--border) solid var(--border-color)`:'none'); const sp=spanMap[key]; if(sp){ div.style.gridColumn=`span ${sp.cs}`; div.style.gridRow=`span ${sp.rs}`; } frag.appendChild(div); elemMap[key]=div; } } grid.appendChild(frag); fitToWidth(); }

/***** 索引＆ハイライト *****/
function buildShelfIndex(){ shelfToAnchors=new Map(); const cells=current.cells||{}; const seen=new Set(); Object.entries(cells).forEach(([key,d])=>{ const v=String(d.v||'').trim(); if(!/^\d+$/.test(v)) return; const anchor=ownerMap[key]||key; if(seen.has(anchor)) return; seen.add(anchor); const list=shelfToAnchors.get(v)||[]; list.push(anchor); shelfToAnchors.set(v,list); }); }
function clearHits(){ document.querySelectorAll('.cell.hit').forEach(el=>el.classList.remove('hit')); }
function highlightAnchors(anchorKeys){ clearHits(); let first=null; (anchorKeys||[]).forEach(k=>{ const el=elemMap[k]; if(el){ el.classList.add('hit'); if(!first) first=el; } }); if(first) first.scrollIntoView({behavior:'smooth', block:'center', inline:'center'}); }

/***** 検索 *****/
function searchByJanLocal(jan){ const shelves=janIndex[jan]||[]; if(!shelves.length){ $('status').textContent=`JAN ${jan} は見つかりません`; clearHits(); return; } const anchors=[]; shelves.forEach(s=>{ const list=shelfToAnchors.get(String(s))||[]; anchors.push(...list); }); if(!anchors.length){ $('status').textContent=`棚番は見つかったが Floor1 に一致セルがありません: ${shelves.join(', ')}`; clearHits(); return; } highlightAnchors(anchors); $('status').textContent=`JAN ${jan} → 棚番 ${shelves.join(', ')} を表示`; }
function searchText(q){ clearHits(); const cells=current.cells||{}; let first=null, count=0, marked=new Set(); Object.entries(cells).forEach(([key,d])=>{ const txt=(d.v||'')+' '+(d.n||''); if(!txt || !txt.toLowerCase().includes(q.toLowerCase())) return; const anchor=ownerMap[key]||key; if(marked.has(anchor)) return; marked.add(anchor); const el=elemMap[anchor]; if(el){ el.classList.add('hit'); count++; if(!first) first=el; } }); if(first) first.scrollIntoView({behavior:'smooth', block:'center', inline:'center'}); $('status').textContent = count ? `検索ヒット: ${count} 件` : '該当なし'; }

/***** 初期読み込み（段階的進捗） *****/
async function initLoad(){
  try{
    $('loader').style.display='flex'; $('status').textContent='';
    startProgress(); setProgressTarget(8);
    const idToken=liff.getIDToken();
    setProgressTarget(15); setProgressTarget(25);
    let res = await callServer({ action:'initBundle', idToken }).catch(e=>({ok:false,error:String(e)}));
    if(!res.ok && /unknown action/i.test(res.error||'')){
      setProgressTarget(35);
      const mapRes=await callServer({ action:'storeMap', idToken });
      if(!mapRes.ok) throw new Error(mapRes.error||'storeMap failed');
      setProgressTarget(45);
      let idxRes=await callServer({ action:'dataIndex', idToken }).catch(()=>null);
      res={ ok:true, map:mapRes, index:(idxRes&&idxRes.ok)?idxRes.index:{}, janCount:(idxRes&&idxRes.ok)?idxRes.count:0 };
    }
    if(!res.ok) throw new Error(res.error||'init failed');
    setProgressTarget(55);
    const m=res.map||{}; current={ rows:+(m.rows||0), cols:+(m.cols||0), cells:m.cells||{}, merges:m.merges||[] };
    setProgressTarget(65); buildMergeMaps();
    setProgressTarget(75); renderGrid();
    setProgressTarget(85); janIndex=res.index||{}; buildShelfIndex();
    setProgressTarget(100);
    $('status').textContent=`初期読込完了（JAN: ${res.janCount||0} 件${res.cacheKey?`, cache:${res.cacheKey}`:''}）`;
  }catch(e){
    console.error(e);
    $('status').textContent='初期読み込みに失敗: '+(e?.message||e);
    alert('初期読み込みに失敗しました：'+(e?.message||e));
    hideProgress();
  }finally{
    $('loader').style.display='none';
  }
}

/***** 初期化・イベント *****/
(async ()=>{
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  await initLoad();
})();
$('btnSearch').addEventListener('click', ()=>{ const q=$('inputQuery').value.trim(); if(/^\d{13}$/.test(q)) searchByJanLocal(q); else searchText(q); });
$('inputQuery').addEventListener('keydown', e=>{ if(e.key==='Enter'){ const q=$('inputQuery').value.trim(); if(/^\d{13}$/.test(q)) searchByJanLocal(q); else searchText(q); }});
$('btnClear').addEventListener('click', ()=>{ $('inputQuery').value=''; clearHits(); $('status').textContent=''; });
window.addEventListener('resize', ()=>{ if(current.cols) fitToWidth(); });

/* =========================
   ライブ読み取り：Html5Qrcode
   画像読み取り：Quagga2（フォールバック）
   さらに：getUserMedia プレビューで根本確認
   ========================= */
let html5qrcode = null;     // ライブ用
let liveActive = false;
let quaggaReady = false;    // 画像デコード用
let previewStream = null;   // 根本確認用プレビュー

async function ensureHtml5Qrcode(){
  if(window.Html5Qrcode) return;
  await loadScript('https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js');
}
async function ensureQuagga(){
  if(window.Quagga) return quaggaReady = true;
  await loadScript('https://unpkg.com/@ericblade/quagga2@2.0.0-beta.3/dist/quagga.js');
  quaggaReady = !!window.Quagga;
}

/* ライブ開始 */
async function startLive(){
  await ensureHtml5Qrcode();
  $('#scannerModal').style.display='flex';
  const formatsToSupport = [ window.Html5QrcodeSupportedFormats.EAN_13 ];
  const config = {
    fps: 15,
    qrbox: (w, h) => { const size = Math.min(w, h) * 0.8; return { width: Math.floor(size), height: Math.floor(size/3) }; },
    rememberLastUsedCamera: true,
    supportedScanTypes: [ Html5QrcodeScanType.SCAN_TYPE_CAMERA ],
    formatsToSupport
  };
  if(!html5qrcode) html5qrcode = new Html5Qrcode('reader', { verbose: false });

  try{
    await html5qrcode.start(
      { facingMode: "environment" },
      config,
      (decodedText) => {
        const jan = String(decodedText||'').replace(/\D/g,'');
        if(/^\d{13}$/.test(jan)){ onScanResult(jan); }
      },
      () => {} // onDecodeFailure: 無視
    );
    liveActive = true;
    // プレビューUIは閉じておく
    $('#previewWrap').style.display = 'none';
  }catch(e){
    console.warn('Html5Qrcode start failed:', e);
    // ライブが使えない→根本確認UIを開く
    $('#previewWrap').style.display = 'flex';
    $('#previewMsg').textContent = 'ライブ読み取りの起動に失敗しました。下の「カメラをテスト起動」でプレビューを確認してください。';
  }
}

/* ライブ停止 */
async function stopLive(){
  try{ if(html5qrcode && liveActive){ await html5qrcode.stop(); liveActive=false; } }catch(_){}
  try{ if(html5qrcode){ await html5qrcode.clear(); } }catch(_){}
}

/* 画像から読み取り（フォールバック） */
async function decodeFromFile(file){
  await ensureQuagga();
  if(!quaggaReady){ alert('デコード用ライブラリ読み込みに失敗しました。ネットワーク設定をご確認ください。'); return; }

  const dataUrl = await new Promise((res,rej)=>{ const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error||new Error('file read error')); r.readAsDataURL(file); });

  return new Promise((resolve)=>{
    window.Quagga.decodeSingle({
      src: dataUrl,
      numOfWorkers: 0, // iOS WKWebView 対策
      inputStream: { size: 1200 },
      locator: { halfSample: true, patchSize: "medium" },
      decoder: { readers: ["ean_reader","ean_8_reader"] }
    }, (result) => {
      if(result && result.codeResult && result.codeResult.code){
        const jan = String(result.codeResult.code||'').replace(/\D/g,'');
        if(/^\d{13}$/.test(jan)) resolve(jan); else resolve(null);
      }else{
        resolve(null);
      }
    });
  });
}

/* 結果ハンドラ */
function onScanResult(jan){
  closeScanner();
  $('#inputQuery').value = jan;
  searchByJanLocal(jan);
}

/* UI: 開く／閉じる */
function openScanner(){ $('#scannerModal').style.display='flex'; }
async function closeScanner(){ await stopLive(); stopPreview(); $('#scannerModal').style.display='none'; }

/* 根本確認：getUserMedia プレビュー */
async function startPreview(){
  stopPreview();
  const v = $('#previewVideo');
  const msg = $('#previewMsg');
  try{
    const constraints = { video: { facingMode: { ideal:'environment' }, width:{ideal:1280}, height:{ideal:720} }, audio:false };
    previewStream = await navigator.mediaDevices.getUserMedia(constraints);
    v.setAttribute('playsinline',''); v.muted = true;
    v.srcObject = previewStream;
    await v.play();
    msg.textContent = 'プレビューが表示されています。OKならライブ読み取りを再トライします。';
    // いったん停止してライブへ
    setTimeout(async ()=>{
      stopPreview();
      await startLive();
    }, 1500);
  }catch(e){
    const name = e && (e.name||e.message)||String(e);
    let hint = '';
    if(/NotAllowedError|Permission/i.test(name)) hint = '（権限が拒否されています。設定→LINE→カメラを許可）';
    else if(/NotFoundError|DevicesNotFound/i.test(name)) hint = '（カメラデバイスが見つかりません）';
    else if(/OverconstrainedError|Constraint/i.test(name)) hint = '（指定のカメラが利用できません）';
    else if(/SecureContext|https/i.test(name)) hint = '（https でのアクセスが必要です）';
    msg.textContent = 'プレビュー起動に失敗: ' + name + ' ' + hint;
  }
}
function stopPreview(){
  try{
    const v = $('#previewVideo'); if(v){ v.pause(); v.srcObject = null; }
    if(previewStream){ previewStream.getTracks().forEach(t=>t.stop()); }
  }catch(_){}
  previewStream = null;
}

/* イベント */
$('btnScan').addEventListener('click', async ()=>{
  openScanner();
  try{ await startLive(); }catch(_){}
});
$('btnScannerClose').addEventListener('click', async ()=>{ await closeScanner(); });
$('fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const jan = await decodeFromFile(f);
  if(jan) onScanResult(jan);
  else alert('画像からJANを読み取れませんでした。明るい場所で、バーコード全体が写るように撮影してください。');
});
$('previewWrap').style.display = 'none';
$('btnPreviewStart').addEventListener('click', startPreview);
$('btnPreviewStop').addEventListener('click', stopPreview);
</script>
</body>
</html>
