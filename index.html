<!doctype html>
<html lang="ja">
<head>

<!-- ① LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- ② あなたの LIFF ID を設定 -->
<script>window.LIFF_ID = "2007972627-vnAq4qbB";</script>

<!-- ③ LINEアプリ外ブロック用ガード：すべてのHTMLで共通に貼る -->
<style id="liff-guard-style">body{display:none!important}</style>
<script>
(function(){
  var LIFF_ID = window.LIFF_ID || "";
  function allow(){
    var st=document.getElementById('liff-guard-style'); if(st) st.remove();
    if(document.body) document.body.style.display='';
  }
  function block(){
    var deeplink = LIFF_ID ? ('https://liff.line.me/' + encodeURIComponent(LIFF_ID)) : '';
    document.open();
    document.write(
      '<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
      '<title>このページはLINEアプリ専用です</title>'+
      '<style>html,body{height:100%}body{margin:0;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Arial}'+
      '.card{max-width:720px;margin:0 16px;background:#111827;border-radius:14px;padding:18px 16px;border:1px solid rgba(255,255,255,.08)}'+
      '.h{font-weight:800;margin:4px 0 8px;font-size:16px}.p{opacity:.9;line-height:1.6;font-size:14px}'+
      '.btn{margin-top:12px;display:inline-block;background:#06c755;color:#0b2314;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:700}'+
      '</style>'+
      '<div class="card">'+
        '<div class="h">このページは LINE アプリ内でのみ利用できます</div>'+
        '<div class="p">LINE のトーク、または <b>ホーム → サービス</b> から開き直してください。</div>' +
        (deeplink ? '<a class="btn" href="'+deeplink+'">LINEで開く</a>' : '')+
      '</div>'
    );
    document.close();
  }
  function uaLooksLikeLine(){
    var ua = navigator.userAgent || '';
    return /Line\/|LIFF/i.test(ua);
  }
  // SDKが無くてもUAでできるだけ判定
  if(!window.liff){
    if(uaLooksLikeLine()){ allow(); } else { block(); }
    return;
  }
  // LIFF初期化 → アプリ内かどうかで判定
  liff.init({ liffId: LIFF_ID }).then(function(){
    if(liff.isInClient()){ allow(); } else { block(); }
  }).catch(function(){
    if(uaLooksLikeLine()){ allow(); } else { block(); }
  });
})();
</script>
  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>読み込み中…</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden}
html{-webkit-text-size-adjust:100%}
img,video,canvas,svg{max-width:100%;height:auto;display:block}
.container{width:100%;max-width:720px;margin:0 auto;padding:0 16px}
.card{width:100%;max-width:100%;border:1px solid #e5e7eb;border-radius:16px;padding:24px;background:#fff}
.spin{width:32px;height:32px;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#06c755;animation:sp 1s linear infinite;margin:12px auto}
@keyframes sp{to{transform:rotate(360deg)}}
.muted{opacity:.75}
</style>
</head>
<body
  style="
    margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;
    text-align:center;background:#fff;color:#111;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans JP',Arial;
  "
>
  <div class="container">
    <div class="card" role="status" aria-live="polite" style="text-align:center;">
      <div class="spin"></div>
      <h1 style="margin:8px 0 4px;">読み込み中…</h1>
      <div id="msg" class="muted">登録状況を確認中…</div>
    </div>
  </div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzJc0m-1QpRfS_elBV5PyUHOVYCqezuB8Qp3wluj1gvt1LwCzjV-nwsBRySOlPOadN-YA/exec";
const URL_REGISTER = "./register.html";
const URL_HOME     = "./home.html";

const msg = (t)=>document.getElementById('msg').textContent=t;

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

(async ()=>{
  try{
    msg("LIFFを初期化しています…");
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ msg("LINEでログインします…"); liff.login(); return; }
    msg("登録状況を確認中…");
    const idToken = liff.getIDToken();
    const st = await callServer({ idToken, action:"status" });
    if(st.bound){ msg("登録済みです。登録済みページへ…"); location.replace(URL_HOME); }
    else{ msg("未登録です。初回利用登録ページへ…"); location.replace(URL_REGISTER); }
  }catch(err){
    console.error(err); msg("エラー："+(err?.message||err));
  }
})();
</script>
</body>
</html>
