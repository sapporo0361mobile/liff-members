<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <title>読み込み中…</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    html,body{height:100%} body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;background:#fff;color:#111}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{width:min(720px,94vw);border:1px solid #e5e7eb;border-radius:16px;padding:24px;text-align:center}
    .spin{width:32px;height:32px;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#06c755;animation:sp 1s linear infinite;margin:12px auto}
    @keyframes sp{to{transform:rotate(360deg)}}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <div class="wrap"><div class="card">
    <div class="spin"></div>
    <h1 style="margin:8px 0 4px">読み込み中…</h1>
    <div id="msg" class="muted">状態を確認しています</div>
  </div></div>

<script>
  const LIFF_ID = "2007972627-vnAq4qbB";
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby042IR537_dOHo0XTri9kTgdwZVRQQFO_vIJuFLW3_gSkmWQYoVqx0vBFxuDSTAxZajQ/exec"; // ← 差し替え必須
  const URL_REGISTER = "./register.html";
  const URL_HOME     = "./home.html";

  const msg = (t)=>document.getElementById('msg').textContent=t;

  async function callServer(payload){
    const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
    const txt = await r.text(); let j={}; try{ j=JSON.parse(txt);}catch(e){ j={ok:false,error:"JSON parse failed: "+txt} }
    if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
    return j;
  }

  (async ()=>{
    try{
      msg("LIFFを初期化しています…");
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ msg("LINEでログインします…"); liff.login(); return; }

      msg("登録状況を確認中…");
      const idToken = liff.getIDToken();
      const st = await callServer({ idToken, action:"status" });

      if(st.bound){ msg("登録済みです。会員ページへ…"); location.replace(URL_HOME); }
      else{ msg("未登録です。会員登録ページへ…"); location.replace(URL_REGISTER); }
    }catch(err){
      console.error(err); msg("エラー："+(err?.message||err));
    }
  })();
</script>
</body>
</html>
