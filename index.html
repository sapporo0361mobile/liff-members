<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>読み込み中…</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden}
html{-webkit-text-size-adjust:100%}
img,video,canvas,svg{max-width:100%;height:auto;display:block}
.container{width:100%;max-width:720px;margin:0 auto;padding:0 16px}
.card{width:100%;max-width:100%;border:1px solid #e5e7eb;border-radius:16px;padding:24px;background:#fff}
.spin{width:32px;height:32px;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#06c755;animation:sp 1s linear infinite;margin:12px auto}
@keyframes sp{to{transform:rotate(360deg)}}
.muted{opacity:.75}
</style>
</head>
<body
  style="
    margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;
    text-align:center;background:#fff;color:#111;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans JP',Arial;
  "
>
  <div class="container">
    <div class="card" role="status" aria-live="polite" style="text-align:center;">
      <div class="spin"></div>
      <h1 style="margin:8px 0 4px;">読み込み中…</h1>
      <div id="msg" class="muted">登録状況を確認中…</div>
    </div>
  </div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyEx8f6xOOCo7f39LZa0yPRHZFRKrWwS4DxLyHC9znxTkhxyttPaDRO7F30hYjcObPMSQ/exec";
const URL_REGISTER = "./register.html";
const URL_HOME     = "./home.html";

const msg = (t)=>document.getElementById('msg').textContent=t;

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

(async ()=>{
  try{
    msg("LIFFを初期化しています…");
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ msg("LINEでログインします…"); liff.login(); return; }
    msg("登録状況を確認中…");
    const idToken = liff.getIDToken();
    const st = await callServer({ idToken, action:"status" });
    if(st.bound){ msg("登録済みです。会員ページへ…"); location.replace(URL_HOME); }
    else{ msg("未登録です。会員登録ページへ…"); location.replace(URL_REGISTER); }
  }catch(err){
    console.error(err); msg("エラー："+(err?.message||err));
  }
})();
</script>
</body>
</html>
