<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>会員ページ（LIFF）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --sub:#6b7280; --card:#f8fafc; --brand:#06c755;
      --border:#e5e7eb;
    }
    html,body{height:100%;}
    body{margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial;}
    .wrap{
      min-height:100dvh; width:100vw; display:flex; flex-direction:column;
      background:linear-gradient(180deg,#ecfdf5 0%, #ffffff 40%);
      padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
      padding-top: calc(env(safe-area-inset-top) + 8px); padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
    }
    .card{margin: 0 auto; width:100%; max-width:none; background:var(--card); border-radius:0;
      box-shadow:none; padding:16px 16px 24px;}
    @media (min-width: 720px){
      .card{max-width:720px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin-top:24px;}
    }
    .header{display:flex; align-items:center; gap:12px; padding:12px 0 8px;}
    .brandDot{width:36px; height:36px; border-radius:10px; background:var(--brand);
      display:grid; place-items:center; color:#fff; font-weight:700;}
    h1{margin:0; font-size: clamp(18px, 3.8vw, 22px); letter-spacing:.01em;}
    .muted{color:var(--sub);}
    .rows{ margin-top:12px; display:grid; gap:10px; }
    .row{display:flex; align-items:center; justify-content:space-between; background:#fff;
      border:1px solid var(--border); border-radius:12px; padding:12px 14px;}
    .key{ font-size: clamp(12px, 3.4vw, 14px); color:var(--sub); }
    .val{ font-size: clamp(14px, 3.8vw, 16px); font-variation-settings: "wght" 560; }

    .sheet{margin-top:12px; background:#fff; border:1px solid var(--border); border-radius:16px; padding:16px; display:grid; gap:12px;}
    .fld{display:grid; gap:6px;}
    .fld label{font-size:14px; color:#374151;}
    .fld input, .fld select{appearance:none; width:100%; font-size:16px; padding:12px 12px; border-radius:12px;
      border:1px solid var(--border); background:#fff;}
    .actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:8px; }
    .btn{appearance:none; border:none; cursor:pointer; border-radius:12px; padding:12px 16px; font-size:16px; background:var(--brand); color:#fff;}
    .btn-ghost{background:transparent; color:#111827; border:1px solid var(--border);}
    .hidden{display:none;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="brandDot">ID</div>
        <div>
          <h1>会員ページ</h1>
          <div class="muted" id="subtitle">初期化中…</div>
        </div>
      </div>

      <!-- 表示ブロック -->
      <div class="rows" id="viewBox" class="hidden" style="display:none">
        <div class="row"><div class="key">所属店舗</div><div class="val" id="v_store">—</div></div>
        <div class="row"><div class="key">職員コード</div><div class="val" id="v_code">—</div></div>
        <div class="row"><div class="key">氏名</div><div class="val" id="v_name">—</div></div>
        <div class="actions"><button id="logoutBtn" class="btn-ghost hidden">ログアウト</button></div>
      </div>

      <!-- 初回登録フォーム -->
      <div id="formBox" class="sheet hidden">
        <div class="fld">
          <label for="store">所属店舗</label>
          <select id="store">
            <option value="">選択してください</option>
          </select>
        </div>
        <div class="fld">
          <label for="code">職員コード（数字）</label>
          <input id="code" inputmode="numeric" pattern="[0-9]*" placeholder="例：12345">
        </div>
        <div class="fld">
          <label for="lastName">姓</label>
          <input id="lastName" placeholder="例：山田">
        </div>
        <div class="fld">
          <label for="firstName">名</label>
          <input id="firstName" placeholder="例：太郎">
        </div>
        <div class="actions">
          <button id="cancelBtn" class="btn-ghost">キャンセル</button>
          <button id="submitBtn" class="btn">登録する</button>
        </div>
        <div class="muted" id="msg"></div>
      </div>
    </div>
  </div>

<script>
  // 差し替え
  const LIFF_ID = "2007972627-vnAq4qbB";                 // 例: 2000000000-xxxxxx
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby042IR537_dOHo0XTri9kTgdwZVRQQFO_vIJuFLW3_gSkmWQYoVqx0vBFxuDSTAxZajQ/exec";  // 例: https://script.google.com/.../exec

  const $ = (id)=>document.getElementById(id);
  let _idToken = null;

  async function callServer(payload){
    const res = await fetch(GAS_ENDPOINT, { method:'POST', body: JSON.stringify(payload) });
    const text = await res.text();
    let data={}; try{ data=JSON.parse(text);}catch(e){ data={ok:false,error:'JSON parse failed'} }
    if(!res.ok || !data.ok) throw new Error(data.error||('HTTP '+res.status+' '+text));
    return data;
  }

  function fillStores(list){
    const sel = $('store');
    sel.innerHTML = '<option value="">選択してください</option>';
    list.forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s; opt.textContent = s;
      sel.appendChild(opt);
    });
  }

  function showView({store, staffCode, displayName}){
    $('v_store').textContent = store || '(未登録)';
    $('v_code').textContent  = staffCode || '(未登録)';
    $('v_name').textContent  = displayName || '(未登録)';
    $('viewBox').style.display = '';
    $('formBox').classList.add('hidden');
    $('logoutBtn').classList.remove('hidden');
  }

  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }

      _idToken = liff.getIDToken();

      // ステータス確認
      const status = await callServer({ idToken:_idToken, action:'status' });
      if(status.bound){
        $('subtitle').textContent = 'ログイン済み・登録情報を表示';
        showView({ store: status.store, staffCode: status.staffCode, displayName: status.displayName });
        return;
      }

      // 未登録 → 店舗リスト取得してフォーム表示
      $('subtitle').textContent = '初回登録：所属店舗・職員コード・氏名を入力';
      const stores = await callServer({ idToken:_idToken, action:'stores' }); // {stores:[...]}
      fillStores(stores.stores || []);
      $('formBox').classList.remove('hidden');
      $('viewBox').style.display = 'none';
      $('logoutBtn').classList.remove('hidden');

    }catch(err){
      console.error(err);
      $('subtitle').textContent = '初期化エラー：' + (err?.message||err);
    }
  }

  $('submitBtn').addEventListener('click', async ()=>{
    try{
      const store = $('store').value.trim();
      const staffCode = $('code').value.trim();
      const lastName = $('lastName').value.trim();
      const firstName = $('firstName').value.trim();

      if(!store) throw new Error('所属店舗を選択してください');
      if(!/^[0-9]+$/.test(staffCode)) throw new Error('職員コードは数字で入力してください');
      if(!lastName || !firstName) throw new Error('姓・名を入力してください');

      $('msg').textContent = '登録中…';
      const resp = await callServer({
        idToken:_idToken,
        action:'bind',
        store, staffCode, lastName, firstName
      });
      $('msg').textContent = '登録完了';
      $('subtitle').textContent = '登録が完了しました';
      showView({ store: resp.store, staffCode: resp.staffCode, displayName: resp.displayName });
    }catch(err){
      console.error(err);
      $('msg').textContent = 'エラー：' + (err?.message||err);
    }
  });

  $('cancelBtn').addEventListener('click', ()=>{
    $('formBox').classList.add('hidden');
    $('subtitle').textContent = 'キャンセルしました（未登録）';
  });

  $('logoutBtn').addEventListener('click', ()=>{
    try{ if(liff.isLoggedIn()) liff.logout(); }catch(e){}
    location.reload();
  });

  init();
</script>
</body>
</html>
