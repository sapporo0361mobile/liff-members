<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>読み込み中…</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/* --- Anti-Overflow Patch (共通) --- */
*,*::before,*::after{box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden}
html{-webkit-text-size-adjust:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;background:#fff;color:#111}
.wrap{min-height:100svh;min-height:100dvh;width:100%;
  padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);
  padding-top:calc(env(safe-area-inset-top) + 8px);padding-bottom:calc(env(safe-area-inset-bottom) + 16px)}
img,video,canvas,svg{max-width:100%;height:auto;display:block}
/* --- page --- */
.center{min-height:calc(100dvh - 48px);display:grid;place-items:center}
.card{width:100%;max-width:720px;border:1px solid #e5e7eb;border-radius:16px;padding:24px;margin:0 16px}
.spin{width:32px;height:32px;border-radius:50%;border:3px solid #e5e7eb;border-top-color:#06c755;animation:sp 1s linear infinite;margin:12px auto}
@keyframes sp{to{transform:rotate(360deg)}}
.muted{opacity:.75}
</style>
</head>
<body>
<div class="wrap">
  <div class="center">
    <div class="card" role="status" aria-live="polite">
      <div class="spin"></div>
      <h1 style="margin:8px 0 4px">読み込み中…</h1>
      <div id="msg" class="muted">登録状況を確認中…</div>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby042IR537_dOHo0XTri9kTgdwZVRQQFO_vIJuFLW3_gSkmWQYoVqx0vBFxuDSTAxZajQ/exec"; // ← 差し替え
const URL_REGISTER = "./register.html";
const URL_HOME     = "./home.html";

const msg = (t)=>document.getElementById('msg').textContent=t;

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

(async ()=>{
  try{
    msg("LIFFを初期化しています…");
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ msg("LINEでログインします…"); liff.login(); return; }
    msg("登録状況を確認中…");
    const idToken = liff.getIDToken();
    const st = await callServer({ idToken, action:"status" });
    if(st.bound){ msg("登録済みです。会員ページへ…"); location.replace(URL_HOME); }
    else{ msg("未登録です。会員登録ページへ…"); location.replace(URL_REGISTER); }
  }catch(err){
    console.error(err); msg("エラー："+(err?.message||err));
  }
})();
</script>
</body>
</html>
