<!doctype html>
<html lang="ja">
<head>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- LIFFガード（LINEアプリ外ブロック） -->
  <script>window.LIFF_ID="2007972627-vnAq4qbB";</script>
  <style id="liff-guard-style">body{display:none!important}</style>
  <script>
    (function(){
      var LIFF_ID=window.LIFF_ID||"";
      function allow(){ var st=document.getElementById('liff-guard-style'); if(st) st.remove(); if(document.body) document.body.style.display=''; }
      function block(){
        var deeplink = LIFF_ID ? ('https://liff.line.me/'+encodeURIComponent(LIFF_ID)) : '';
        document.open();document.write('<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>このページはLINEアプリ専用です</title><style>html,body{height:100%}body{margin:0;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Arial}.card{max-width:720px;margin:0 16px;background:#111827;border-radius:14px;padding:18px 16px;border:1px solid rgba(255,255,255,.08)}.h{font-weight:800;margin:4px 0 8px;font-size:16px}.p{opacity:.9;line-height:1.6;font-size:14px}.btn{margin-top:12px;display:inline-block;background:#06c755;color:#0b2314;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:700}</style><div class="card"><div class="h">このページは LINE アプリ内でのみ利用できます</div><div class="p">LINE のトーク、または <b>ホーム → サービス</b> から開き直してください。</div>'+(deeplink?'<a class="btn" href="'+deeplink+'">LINEで開く</a>':'')+'</div>');document.close();
      }
      function uaLooksLikeLine(){ var ua=navigator.userAgent||''; return /Line\/|LIFF/i.test(ua); }
      if(!window.liff){ if(uaLooksLikeLine()){ allow(); } else { block(); } return; }
      liff.init({ liffId: LIFF_ID }).then(function(){ if(liff.isInClient()){ allow(); } else { block(); } })
        .catch(function(){ if(uaLooksLikeLine()){ allow(); } else { block(); } });
    })();
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>学習クイズ</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;display:flex;flex-direction:column}
    .container{max-width:880px;margin:0 auto;padding:16px 16px 80px;width:100%}
    .card{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:14px;padding:16px}
    .card + .card{margin-top:12px}
    h1{margin:0 0 8px;font-size:18px;font-weight:800}
    .muted{color:#64748b}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:#06c755;color:#0b2314}
    .btn.secondary{background:#e2e8f0;color:#0f172a}
    .btn.ghost{background:#fff;border:1px solid rgba(2,6,23,.12);color:#0f172a}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .opt{display:block;width:100%;text-align:left}
    .opt.disabled{opacity:.65;pointer-events:none}
    .opt.correct{border:1px solid #16a34a;background:#dcfce7}
    .opt.wrong{border:1px solid #b91c1c;background:#fee2e2}
    .qno{font-weight:800}
    .exp{margin-top:10px;padding:12px;border-radius:12px;background:#f1f5f9;border:1px solid rgba(2,6,23,.06)}
    .bottom-nav{display:flex;justify-content:space-around;align-items:center;height:56px;background:#fff;border-top:1px solid rgba(2,6,23,.08);position:fixed;bottom:0;left:0;right:0;z-index:50}
    .bottom-nav button{flex:1;appearance:none;background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;color:#475569;padding:4px 0}
    .bottom-nav .material-icons{font-size:24px;color:#0f172a}
  </style>
</head>
<body>
  <div class="container">
    <!-- 設定 -->
    <section class="card" id="setup">
      <h1>学習クイズ</h1>
      <div class="muted" id="uinfo">初期化中…</div>

      <div style="margin-top:10px">
        <div><strong>教材（スプレッドシート）</strong></div>
        <div class="list" id="bookList"></div>
      </div>

      <div style="margin-top:10px">
        <div><strong>出題範囲（シート）</strong></div>
        <div class="list" id="sheetList"></div>
      </div>

      <div style="margin-top:10px">
        <div><strong>出題順</strong></div>
        <div class="row" role="group" aria-label="order">
          <label><input type="radio" name="order" value="seq" checked> 順番どおり</label>
          <label><input type="radio" name="order" value="rand"> ランダム</label>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnStart" class="btn primary"><span class="material-icons" style="vertical-align:middle">play_arrow</span>開始</button>
        <button id="btnReset" class="btn ghost">選択クリア</button>
      </div>
      <div class="muted" id="setupMsg"></div>
    </section>

    <!-- 出題 -->
    <section class="card" id="quiz" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div><span class="pill" id="sheetName">-</span></div>
        <div class="muted"><span id="progress">0/0</span>・正解 <span id="score">0</span></div>
      </div>
      <div style="margin-top:8px">
        <div class="qno" id="qno"></div>
        <div id="qtext" style="margin:6px 0 8px;white-space:pre-wrap"></div>
      </div>
      <div class="list" id="opts"></div>
      <div class="exp" id="explain" style="display:none"></div>

      <div class="row" style="margin-top:10px">
        <button id="btnNext" class="btn secondary" disabled>次の問題</button>
        <button id="btnFinish" class="btn ghost">終了</button>
      </div>
    </section>
  </div>

  <!-- 既存ナビ（必要ならそのまま） -->
  <nav class="bottom-nav">
    <button onclick="location.href='./index.html'"><span class="material-icons">home</span><div>ホーム</div></button>
    <button onclick="location.href='./contacts.html'"><span class="material-icons">chat</span><div>チャット</div></button>
    <button onclick="location.href='./shift.html'"><span class="material-icons">calendar_month</span><div>シフト</div></button>
    <button onclick="location.href='./tools.html'"><span class="material-icons">build</span><div>ツール</div></button>
    <button onclick="location.href='./settings.html'"><span class="material-icons">settings</span><div>設定</div></button>
  </nav>

<script>
/* ===== 設定 ===== */
const LIFF_ID = "2007972627-vnAq4qbB";
const MAIN_GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxRi0b_BXD3in9T5gF_GO7BI5j_jpm23sv_3DTdTHv7AhuTsGmXi4rxgIWdRW9OB8q8dA/exec"; // 会員チェック不要なら空のまま
const QUIZ_GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyaHEFtQAhD5E9rlqxcFCbNIdwP3mgNY5GaSTBPl4mHEdFKyhKK0CzERr5soHSaU9el/exec";

const $ = (id)=>document.getElementById(id);
function msg(t){ $('setupMsg').textContent = t||''; }
async function postJSON(url, payload){
  const r = await fetch(url,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

/* ===== 状態 ===== */
let BOOKS = [];      // {key,label}[]
let CURRENT_BOOK=''; // 選択中 bookKey
let QUESTIONS=[]; let ORDER='seq'; let idx=0; let score=0;

/* ===== 画面遷移 ===== */
function showSetup(){ $('setup').style.display=''; $('quiz').style.display='none'; }
function showQuiz(){ $('setup').style.display='none'; $('quiz').style.display=''; }

/* ===== 教材一覧 → ラジオ ===== */
async function loadBooks(){
  const res = await postJSON(QUIZ_GAS_ENDPOINT,{ action:'quizBooks', idToken:liff.getIDToken() });
  BOOKS = res.books||[];
  const box = $('bookList'); box.innerHTML='';
  if(!BOOKS.length){ box.innerHTML='<div class="muted">教材がありません</div>'; return; }
  BOOKS.forEach((b,i)=>{
    const id='bk_'+b.key;
    const label=document.createElement('label');
    label.className='btn ghost';
    label.style.display='inline-flex'; label.style.alignItems='center'; label.style.gap='8px'; label.style.padding='8px 10px';
    label.innerHTML=`<input type="radio" name="book" id="${id}" value="${b.key}" ${i===0?'checked':''}> ${b.label}`;
    box.appendChild(label);
  });
  CURRENT_BOOK = BOOKS[0]?.key || '';
  await loadSheetList(CURRENT_BOOK);
}

/* ===== シート一覧（選択中教材から全表示） ===== */
async function loadSheetList(bookKey){
  CURRENT_BOOK = bookKey;
  const res = await postJSON(QUIZ_GAS_ENDPOINT,{ action:'quizSheets', idToken:liff.getIDToken(), bookKey });
  const list = res.sheets||[];
  const box = $('sheetList'); box.innerHTML='';
  if(!list.length){ box.innerHTML='<div class="muted">シートが見つかりません</div>'; return; }
  list.forEach(name=>{
    const label=document.createElement('label');
    label.className='btn ghost';
    label.style.display='flex'; label.style.alignItems='center'; label.style.gap='8px'; label.style.padding='8px 10px';
    label.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
    box.appendChild(label);
  });
}

/* ===== 出題開始 ===== */
async function startQuiz(){
  try{
    msg(''); score=0; idx=0; QUESTIONS=[];
    const checked = Array.from(document.querySelectorAll('#sheetList input[type=checkbox]:checked')).map(i=>i.value);
    if(!CURRENT_BOOK){ msg('教材を選択してください'); return; }
    if(!checked.length){ msg('出題範囲（シート）を1つ以上選んでください'); return; }
    ORDER = (document.querySelector('input[name="order"]:checked')?.value==='rand') ? 'rand' : 'seq';

    const res = await postJSON(QUIZ_GAS_ENDPOINT,{
      action:'quizLoad', idToken:liff.getIDToken(), bookKey: CURRENT_BOOK, sheets: checked
    });
    const rows = res.items||[];
    if(!rows.length){ msg('問題が見つかりません'); return; }

    QUESTIONS = rows.map(r=>({
      sheet:r.sheet, no:r.no, text:r.text,
      choices:[r.c1,r.c2,r.c3,r.c4].filter(x=>x!==undefined && x!==''),
      answer:Number(r.ans||0), explain:r.explain||''
    }));
    if(ORDER==='rand'){
      for(let i=QUESTIONS.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [QUESTIONS[i],QUESTIONS[j]]=[QUESTIONS[j],QUESTIONS[i]]; }
    }
    renderQuestion(); showQuiz();
  }catch(e){ msg('読み込みに失敗しました：'+(e?.message||e)); }
}

/* ===== 出題＆採点 ===== */
function renderQuestion(){
  const total=QUESTIONS.length; if(idx>=total){ finishQuiz(); return; }
  const q=QUESTIONS[idx];
  $('sheetName').textContent=q.sheet; $('progress').textContent=`${idx+1}/${total}`; $('score').textContent=`${score}`;
  $('qno').textContent=`問題 ${q.no||idx+1}`; $('qtext').textContent=q.text;
  const box=$('opts'); box.innerHTML='';
  q.choices.forEach((label,i)=>{
    const n=i+1; const btn=document.createElement('button');
    btn.className='btn ghost opt';
    btn.innerHTML=`<span class="material-icons" style="vertical-align:middle;margin-right:6px">radio_button_unchecked</span>${n}. ${label}`;
    btn.onclick=()=>answer(n,btn);
    box.appendChild(btn);
  });
  $('explain').style.display='none'; $('explain').textContent=''; $('btnNext').disabled=true;
}
function answer(n,btnEl){
  const q=QUESTIONS[idx]; const opts=Array.from(document.querySelectorAll('.opt'));
  opts.forEach((b,k)=>{
    const ans=(k+1)===q.answer;
    if(ans){ b.classList.add('correct'); b.querySelector('.material-icons').textContent='check_circle'; }
    if(b===btnEl && !ans){ b.classList.add('wrong'); b.querySelector('.material-icons').textContent='cancel'; }
    b.classList.add('disabled');
  });
  if(n===q.answer) score++; $('score').textContent=`${score}`;
  if(q.explain){ $('explain').style.display='block'; $('explain').textContent=q.explain; }
  $('btnNext').disabled=false;
}
function nextQuestion(){ idx++; renderQuestion(); }
async function finishQuiz(){
  try{
    await postJSON(QUIZ_GAS_ENDPOINT,{ action:'quizLog', idToken:liff.getIDToken(), total:QUESTIONS.length, correct:score, sheets:Array.from(document.querySelectorAll('#sheetList input:checked')).map(i=>i.value), bookKey: CURRENT_BOOK });
  }catch(_){}
  showSetup(); msg(`学習終了：${QUESTIONS.length}問中 ${score}問正解。おつかれさま！`);
}

/* ===== 初期化 ===== */
(async ()=>{
  try{
    $('uinfo').textContent='初期化中…';
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }

    if(MAIN_GAS_ENDPOINT){
      try{
        const st=await postJSON(MAIN_GAS_ENDPOINT,{ action:'status', idToken:liff.getIDToken() });
        if(!st.bound){ location.replace('./register.html'); return; }
        $('uinfo').textContent = `${st.store||''} ${st.lastName||''} ${st.firstName||''}`.trim();
      }catch{ $('uinfo').textContent=''; }
    }else{
      $('uinfo').textContent='';
    }

    await loadBooks(); // 教材一覧 → 先頭選択 → シート一覧
  }catch(e){
    $('uinfo').textContent='初期化エラー：'+(e?.message||e);
  }
})();

/* ===== イベント ===== */
document.addEventListener('change', (e)=>{
  if(e.target && e.target.name==='book'){ loadSheetList(e.target.value); }
});
$('btnStart').addEventListener('click', startQuiz);
$('btnReset').addEventListener('click', ()=>{ document.querySelectorAll('#sheetList input[type=checkbox]').forEach(c=>c.checked=false); msg(''); });
$('btnNext').addEventListener('click', nextQuestion);
$('btnFinish').addEventListener('click', finishQuiz);
</script>
</body>
</html>
