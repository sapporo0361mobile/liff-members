<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>保険募集人クイズ</title>

  <!-- （任意）LIFF：idTokenを使いたい場合だけ。不要なら読み込み/使用とも省略可。 -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>window.LIFF_ID="2007972627-vnAq4qbB";</script>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial}
    .container{max-width:880px;margin:0 auto;padding:16px 16px 64px}
    .card{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:14px;padding:16px}
    .card + .card{margin-top:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:#06c755;color:#0b2314}
    .btn.secondary{background:#e2e8f0;color:#0f172a}
    .btn.ghost{background:#fff;border:1px solid rgba(2,6,23,.12);color:#0f172a}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .opt{display:block;width:100%;text-align:left}
    .opt.disabled{opacity:.65;pointer-events:none}
    .opt.correct{border:1px solid #16a34a;background:#dcfce7}
    .opt.wrong{border:1px solid #b91c1c;background:#fee2e2}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .muted{color:#64748b}
    .qno{font-weight:800}
    .exp{margin-top:10px;padding:12px;border-radius:12px;background:#f1f5f9;border:1px solid rgba(2,6,23,.06)}
    /* ローディング用 */
    .spin{width:16px;height:16px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:#06c755;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="container">
  <!-- 設定 -->
  <section class="card" id="setup">
    <h1 style="margin:0 0 8px">保険募集人クイズ</h1>
    <div class="muted" id="uinfo">準備中…</div>

    <div style="margin-top:10px">
      <div><strong>教材を選択</strong></div>
      <div class="row" id="bookList"></div>
    </div>

    <div style="margin-top:10px">
      <div><strong>出題範囲</strong></div>
      <div class="list" id="sheetList"></div>
    </div>

    <div style="margin-top:10px">
      <div><strong>出題順</strong></div>
      <div class="row">
        <label><input type="radio" name="order" value="seq" checked> 順番どおり</label>
        <label><input type="radio" name="order" value="rand"> ランダム</label>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnStart" class="btn primary">開始</button>
      <button id="btnReset" class="btn ghost">選択クリア</button>
    </div>
    <div class="muted" id="setupMsg"></div>
  </section>

  <!-- 出題 -->
  <section class="card" id="quiz" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div><span class="pill" id="sheetName">-</span></div>
      <div class="muted"><span id="progress">0/0</span>・正解 <span id="score">0</span></div>
    </div>
    <div style="margin-top:8px">
      <div class="qno" id="qno"></div>
      <div id="qtext" style="margin:6px 0 8px;white-space:pre-wrap"></div>
    </div>
    <div class="list" id="opts"></div>
    <div class="exp" id="explain" style="display:none"></div>
    <div class="row" style="margin-top:10px">
      <button id="btnNext" class="btn secondary" disabled>次の問題</button>
      <button id="btnFinish" class="btn ghost">終了</button>
    </div>
  </section>
</div>

<script>
/* ==== 設定 ==== */
// ★ デプロイしたクイズGASのWebアプリURLに置き換え
const QUIZ_GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwW9-ev9Y-MM7lhufb6Gd6K9ApJNPfPQj94UkqRpi6hx0T5AvAQp3yyLw2lcehFFnbQNg/exec";

const $ = id => document.getElementById(id);
function msg(t){ $('setupMsg').textContent = t||''; }

/* 共通POST */
async function postJSON(url, payload){
  const r = await fetch(url,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

/* 状態 */
let BOOK_KEY = null;          // 'basic' | 'pro'
let QUESTIONS=[], ORDER='seq', idx=0, score=0;
let idToken = null;           // 任意：LIFFを使う場合だけ

/* 画面切替 */
function showSetup(){ $('setup').style.display=''; $('quiz').style.display='none'; }
function showQuiz(){ $('setup').style.display='none'; $('quiz').style.display=''; }

/* 教材リストの取得＆表示 */
async function loadBooks(){
  const box = $('bookList');
  box.innerHTML = `<span class="spin"></span>&nbsp;読み込み中…`;
  try{
    const res = await postJSON(QUIZ_GAS_ENDPOINT, { action:'books', idToken });
    const books = res.books || [];
    if(!books.length){ box.innerHTML = '<div class="muted">教材が見つかりません</div>'; return; }

    box.innerHTML = '';
    books.forEach(b=>{
      const label = document.createElement('label');
      label.className = 'btn ghost';
      label.style.padding = '6px 10px';
      label.innerHTML = `<input type="radio" name="book" value="${b.key}"> ${b.label}`;
      box.appendChild(label);
    });

    // 既定は先頭
    const first = box.querySelector('input[name=book]');
    if(first){ first.checked = true; BOOK_KEY = first.value; await loadSheetList(BOOK_KEY); }

    // 変更イベント
    box.addEventListener('change', async (e)=>{
      if(e.target && e.target.name==='book'){
        BOOK_KEY = e.target.value;
        await loadSheetList(BOOK_KEY); // 教材変更→シート更新（読み込み中表示あり）
      }
    });
  }catch(e){
    box.innerHTML = '<div class="muted">教材の取得に失敗しました</div>';
    msg('教材取得エラー：'+(e?.message||e));
  }
}

/* シート一覧の取得＆表示（読み込み中表示つき） */
async function loadSheetList(bookKey){
  const box = $('sheetList');
  box.innerHTML = `<div class="muted" style="display:flex;align-items:center;gap:8px">
    <span class="spin"></span>読み込み中…
  </div>`;
  try{
    const res = await postJSON(QUIZ_GAS_ENDPOINT, { action:'quizSheets', bookKey, idToken });
    const list = (res.sheets || []).filter(name => !/^quizlogs$/i.test(name)); // 念のため
    if(!list.length){ box.innerHTML = '<div class="muted">シートが見つかりません</div>'; return; }

    box.innerHTML = '';
    list.forEach(name=>{
      const label = document.createElement('label');
      label.className = 'btn ghost';
      label.style.display='flex'; label.style.alignItems='center'; label.style.gap='8px'; label.style.padding='8px 10px';
      label.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
      box.appendChild(label);
    });

    // 「第1章」があれば既定でチェック
    const chk = Array.from(box.querySelectorAll('input[type=checkbox]')).find(i=>i.value==='第1章');
    if(chk) chk.checked = true;
    msg('');
  }catch(e){
    box.innerHTML = '<div class="muted">読み込みに失敗しました</div>';
    msg('シート取得エラー：'+(e?.message||e));
  }
}

/* 出題開始（開始中表示つき） */
async function startQuiz(){
  try{
    msg('開始しています…');             // ← 開始中メッセージ
    $('btnStart').disabled = true;

    score=0; idx=0; QUESTIONS=[];
    const checked = Array.from(document.querySelectorAll('#sheetList input[type=checkbox]:checked')).map(i=>i.value);
    if(!checked.length){ msg('出題範囲（シート）を1つ以上選んでください'); $('btnStart').disabled=false; return; }
    ORDER = (document.querySelector('input[name="order"]:checked')?.value === 'rand') ? 'rand' : 'seq';

    const res = await postJSON(QUIZ_GAS_ENDPOINT, { action:'quizLoad', bookKey:BOOK_KEY, sheets: checked, idToken });
    const rows = res.items || [];
    if(!rows.length){ msg('問題が見つかりません。列配置(A..H)・正解(G)をご確認ください。'); $('btnStart').disabled=false; return; }

    QUESTIONS = rows.map(r=>({
      sheet: r.sheet, no: r.no, text: r.text,
      choices: [r.c1,r.c2,r.c3,r.c4].filter(x=>x!==undefined && x!==''),
      answer: Number(r.ans||0), explain: r.explain || ''
    }));

    if(ORDER==='rand'){
      for(let i=QUESTIONS.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [QUESTIONS[i],QUESTIONS[j]]=[QUESTIONS[j],QUESTIONS[i]]; }
    }

    renderQuestion();
    showQuiz();
    msg('');
  }catch(e){
    msg('読み込みに失敗しました：'+(e?.message||e));
  }finally{
    $('btnStart').disabled = false;
  }
}

/* 出題＆採点 */
function renderQuestion(){
  const total = QUESTIONS.length;
  if(idx>=total){ finishQuiz(); return; }
  const q = QUESTIONS[idx];
  $('sheetName').textContent = q.sheet;
  $('progress').textContent  = `${idx+1}/${total}`;
  $('score').textContent     = `${score}`;
  $('qno').textContent       = `問題 ${q.no||idx+1}`;
  $('qtext').textContent     = q.text;

  const box = $('opts'); box.innerHTML = '';
  q.choices.forEach((label, i)=>{
    const n=i+1;
    const btn = document.createElement('button');
    btn.className = 'btn ghost opt';
    btn.textContent = `${n}. ${label}`;
    btn.onclick = ()=> answer(n, btn);
    box.appendChild(btn);
  });

  $('explain').style.display='none';
  $('explain').textContent='';
  $('btnNext').disabled = true;
}
function answer(n, btnEl){
  const q = QUESTIONS[idx];
  const opts = Array.from(document.querySelectorAll('.opt'));
  opts.forEach((b,k)=>{
    const ans = (k+1)===q.answer;
    if(ans){ b.classList.add('correct'); }
    if(b===btnEl && !ans){ b.classList.add('wrong'); }
    b.classList.add('disabled');
  });
  if(n===q.answer) score++;
  $('score').textContent = `${score}`;
  if(q.explain){ $('explain').style.display='block'; $('explain').textContent = q.explain; }
  $('btnNext').disabled = false;
}
function nextQuestion(){ idx++; renderQuestion(); }

/* 終了（任意で学習ログ送信。QuizLogsはUIに出ない） */
async function finishQuiz(){
  showSetup();
  msg(`学習終了：${QUESTIONS.length}問中 ${score}問正解でした。`);
  try{
    await postJSON(QUIZ_GAS_ENDPOINT, {
      action:'quizLog', bookKey:BOOK_KEY, total: QUESTIONS.length, correct: score,
      sheets: Array.from(document.querySelectorAll('#sheetList input[type=checkbox]:checked')).map(i=>i.value),
      idToken
    });
  }catch(_){}
}

/* 起動 */
(async ()=>{
  $('uinfo').textContent = '初期化中…';
  try{
    // idTokenを使いたい場合だけ。不要ならこの3行は消してください。
    try{
      await liff.init({ liffId: window.LIFF_ID });
      if(liff.isLoggedIn()) idToken = liff.getIDToken();
    }catch(_){ /* 非LINE環境でもそのまま動作 */ }

    await loadBooks();          // 教材一覧→初回シートも読み込み
    $('uinfo').textContent = '教材を選んで、出題範囲を選択してから「開始」を押してください';
  }catch(e){
    $('uinfo').textContent = '初期化エラー：'+(e?.message||e);
  }
})();

/* イベント */
$('btnStart').addEventListener('click', startQuiz);
$('btnReset').addEventListener('click', ()=>{
  document.querySelectorAll('#sheetList input[type=checkbox]').forEach(c=>c.checked=false);
  msg('');
});
$('btnNext').addEventListener('click', nextQuestion);
$('btnFinish').addEventListener('click', finishQuiz);
</script>
</body>
</html>
