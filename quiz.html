<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>保険募集人クイズ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial}
    .container{max-width:880px;margin:0 auto;padding:16px 16px 64px}
    .card{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:14px;padding:16px}
    .card + .card{margin-top:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:#06c755;color:#0b2314}
    .btn.secondary{background:#e2e8f0;color:#0f172a}
    .btn.ghost{background:#fff;border:1px solid rgba(2,6,23,.12);color:#0f172a}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
    .opt{display:block;width:100%;text-align:left}
    .opt.disabled{opacity:.65;pointer-events:none}
    .opt.correct{border:1px solid #16a34a;background:#dcfce7}
    .opt.wrong{border:1px solid #b91c1c;background:#fee2e2}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .muted{color:#64748b}
    .qno{font-weight:800}
    .exp{margin-top:10px;padding:12px;border-radius:12px;background:#f1f5f9;border:1px solid rgba(2,6,23,.06)}
  </style>
</head>
<body>
<div class="container">
  <!-- 設定 -->
  <section class="card" id="setup">
    <h1 style="margin:0 0 8px">保険募集人クイズ</h1>
    <div class="muted" id="uinfo">読み込み中…</div>

    <div style="margin-top:12px">
      <div><strong>教材を選択（スプレッドシート）</strong></div>
      <div class="row" id="bookList"></div>
    </div>

    <div style="margin-top:12px">
      <div><strong>出題範囲（シート）</strong></div>
      <div class="list" id="sheetList"></div>
    </div>

    <div style="margin-top:12px">
      <div><strong>出題順</strong></div>
      <div class="row">
        <label><input type="radio" name="order" value="seq" checked> 順番どおり</label>
        <label><input type="radio" name="order" value="rand"> ランダム</label>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="btnStart" class="btn primary">開始</button>
      <button id="btnReset" class="btn ghost">選択クリア</button>
    </div>
    <div class="muted" id="setupMsg"></div>
  </section>

  <!-- 出題 -->
  <section class="card" id="quiz" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div><span class="pill" id="sheetName">-</span></div>
      <div class="muted"><span id="progress">0/0</span>・正解 <span id="score">0</span></div>
    </div>
    <div style="margin-top:8px">
      <div class="qno" id="qno"></div>
      <div id="qtext" style="margin:6px 0 8px;white-space:pre-wrap"></div>
    </div>
    <div class="list" id="opts"></div>
    <div class="exp" id="explain" style="display:none"></div>
    <div class="row" style="margin-top:10px">
      <button id="btnNext" class="btn secondary" disabled>次の問題</button>
      <button id="btnFinish" class="btn ghost">終了</button>
    </div>
  </section>
</div>

<script>
/* ==== 設定 ==== */
// クイズGAS（上のコードをウェブアプリとしてデプロイしたURL）
const QUIZ_GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzjEb1DoxPO-8IQGgrnVbJJ2HNqxAiry-m72TS6vBqFL9-R3ADUEqVoea1JVGd8DYIPrQ/exec";

/* ==== ユーティリティ ==== */
const $ = id => document.getElementById(id);
function msg(t){ $('setupMsg').textContent = t||''; }
async function postJSON(url, payload){
  const r = await fetch(url,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

/* ==== 状態 ==== */
let BOOKS=[], BOOK_KEY=null;
let QUESTIONS=[], ORDER='seq', idx=0, score=0;

/* ==== 画面切替 ==== */
function showSetup(){ $('setup').style.display=''; $('quiz').style.display='none'; }
function showQuiz(){ $('setup').style.display='none'; $('quiz').style.display=''; }

/* ==== 教材一覧 ==== */
async function loadBooks(){
  const res = await postJSON(QUIZ_GAS_ENDPOINT, { action:'quizBooks' });
  BOOKS = res.books || [];
  const box = $('bookList'); box.innerHTML = '';
  if(!BOOKS.length){ box.innerHTML = '<span class="muted">教材が見つかりません</span>'; return; }

  BOOKS.forEach((b,i)=>{
    const id = 'bk_'+b.key;
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="book" id="${id}" value="${b.key}"> ${b.label}`;
    label.style.padding = '6px 10px';
    box.appendChild(label);
  });

  // 先頭を選択してシート読込
  BOOK_KEY = BOOKS[0].key;
  box.querySelector(`input[value="${BOOK_KEY}"]`).checked = true;
  await loadSheetList(BOOK_KEY);

  // 切替イベント
  box.addEventListener('change', async e=>{
    if(e.target && e.target.name==='book'){
      BOOK_KEY = e.target.value;
      await loadSheetList(BOOK_KEY);
    }
  });
}

/* ==== シート一覧 ==== */
async function loadSheetList(bookKey){
  const res = await postJSON(QUIZ_GAS_ENDPOINT, { action:'quizSheets', bookKey });
  const list = res.sheets || [];
  const box = $('sheetList'); box.innerHTML = '';
  if(!list.length){ box.innerHTML = '<div class="muted">シートが見つかりません</div>'; return; }

  list.forEach(name=>{
    const label = document.createElement('label');
    label.className = 'btn ghost';
    label.style.display='flex'; label.style.alignItems='center'; label.style.gap='8px'; label.style.padding='8px 10px';
    label.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
    box.appendChild(label);
  });

  // 「第1章」があれば既定でチェック
  const chk = Array.from(box.querySelectorAll('input[type=checkbox]')).find(i=>i.value==='第1章');
  if(chk) chk.checked = true;
}

/* ==== 出題開始 ==== */
async function startQuiz(){
  try{
    msg(''); score=0; idx=0; QUESTIONS=[];
    const checked = Array.from(document.querySelectorAll('#sheetList input[type=checkbox]:checked')).map(i=>i.value);
    if(!checked.length){ msg('出題範囲（シート）を1つ以上選んでください'); return; }
    ORDER = (document.querySelector('input[name="order"]:checked')?.value === 'rand') ? 'rand' : 'seq';

    const res = await postJSON(QUIZ_GAS_ENDPOINT, { action:'quizLoad', bookKey: BOOK_KEY, sheets: checked });
    const rows = res.items || [];
    if(!rows.length){ msg('問題が見つかりません'); return; }

    QUESTIONS = rows.map(r=>({
      sheet: r.sheet, no: r.no, text: r.text,
      choices: [r.c1,r.c2,r.c3,r.c4].filter(x=>x!==undefined && x!==''),
      answer: Number(r.ans||0), explain: r.explain || ''
    })).filter(q=> q.text && q.choices.length>=2 && q.answer>=1 && q.answer<=q.choices.length);

    if(ORDER==='rand'){
      for(let i=QUESTIONS.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [QUESTIONS[i],QUESTIONS[j]]=[QUESTIONS[j],QUESTIONS[i]]; }
    }
    renderQuestion(); showQuiz();
  }catch(e){ msg('読み込みに失敗しました：'+(e?.message||e)); }
}

/* ==== 出題 & 採点 ==== */
function renderQuestion(){
  const total = QUESTIONS.length;
  if(idx>=total){ finishQuiz(); return; }
  const q = QUESTIONS[idx];
  $('sheetName').textContent = q.sheet;
  $('progress').textContent  = `${idx+1}/${total}`;
  $('score').textContent     = `${score}`;
  $('qno').textContent       = `問題 ${q.no||idx+1}`;
  $('qtext').textContent     = q.text;

  const box = $('opts'); box.innerHTML = '';
  q.choices.forEach((label, i)=>{
    const n=i+1;
    const btn = document.createElement('button');
    btn.className = 'btn ghost opt';
    btn.textContent = `${n}. ${label}`;
    btn.onclick = ()=> answer(n, btn);
    box.appendChild(btn);
  });

  $('explain').style.display='none';
  $('explain').textContent='';
  $('btnNext').disabled = true;
}
function answer(n, btnEl){
  const q = QUESTIONS[idx];
  const opts = Array.from(document.querySelectorAll('.opt'));
  opts.forEach((b,k)=>{
    const ans = (k+1)===q.answer;
    if(ans){ b.classList.add('correct'); }
    if(b===btnEl && !ans){ b.classList.add('wrong'); }
    b.classList.add('disabled');
  });
  if(n===q.answer) score++;
  $('score').textContent = `${score}`;
  if(q.explain){ $('explain').style.display='block'; $('explain').textContent = q.explain; }
  $('btnNext').disabled = false;
}
function nextQuestion(){ idx++; renderQuestion(); }

async function finishQuiz(){
  try{
    const sheets = Array.from(document.querySelectorAll('#sheetList input[type=checkbox]:checked')).map(i=>i.value);
    await postJSON(QUIZ_GAS_ENDPOINT, { action:'quizLog', bookKey: BOOK_KEY, total: QUESTIONS.length, correct: score, sheets });
  }catch(_){}
  showSetup();
  msg(`学習終了：${QUESTIONS.length}問中 ${score}問正解でした。`);
}

/* ==== 起動 ==== */
(async ()=>{
  try{
    $('uinfo').textContent = '教材一覧を取得中…';
    // 必要なら LIFF ログインを有効化
    // await liff.init({ liffId: "2007972627-vnAq4qbB" });
    // if(!liff.isLoggedIn()){ liff.login(); return; }

    await loadBooks();
    $('uinfo').textContent = '教材と出題範囲（シート）を選んで「開始」してください';
  }catch(e){
    $('uinfo').textContent = '初期化エラー：'+(e?.message||e);
  }
})();
$('btnStart').addEventListener('click', startQuiz);
$('btnReset').addEventListener('click', ()=>{ document.querySelectorAll('#sheetList input[type=checkbox]').forEach(c=>c.checked=false); msg(''); });
$('btnNext').addEventListener('click', nextQuestion);
$('btnFinish').addEventListener('click', finishQuiz);
</script>
</body>
</html>
