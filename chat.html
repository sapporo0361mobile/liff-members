<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>チャット</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden}
body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;display:flex;flex-direction:column}
.wrap{flex:1;display:grid;grid-template-rows:auto 1fr auto;min-height:100svh}
.head{padding:12px 16px;font-weight:700}
.container{width:100%;max-width:880px;margin:0 auto;padding:0 16px}
.card{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
/* 相手リスト */
.peerList{display:flex;gap:8px;overflow:auto;padding:8px}
.peer{flex:0 0 auto;min-width:120px;max-width:60%;border:1px solid rgba(2,6,23,.08);border-radius:12px;padding:8px 10px;cursor:pointer}
.peer.active{outline:2px solid #06c755}
.peer .name{font-weight:700}
.peer .sub{font-size:12px;opacity:.7;overflow-wrap:anywhere}
/* メッセージ */
.chat{display:flex;flex-direction:column;gap:8px;padding:12px;height:52vh;overflow:auto}
.msg{max-width:80%;padding:8px 12px;border-radius:14px;word-break:break-word}
.me{align-self:flex-end;background:#dcfce7;border:1px solid rgba(2,6,23,.1)}
.them{align-self:flex-start;background:#fff;border:1px solid rgba(2,6,23,.12)}
.time{font-size:11px;opacity:.6;margin-top:2px}
/* 入力 */
.inputRow{display:flex;gap:8px;padding:12px;position:sticky;bottom:0;background:#f6f8fc}
.inputRow input{flex:1;font-size:16px;padding:12px;border-radius:12px;border:1px solid rgba(2,6,23,.12);background:#fff}
.inputRow button{appearance:none;border:none;border-radius:12px;padding:12px 16px;background:#06c755;color:#0b1b13;font-weight:700;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="head container">チャット</div>

  <div class="container" style="margin-top:6px">
    <div class="card">
      <div id="peers" class="peerList" aria-label="相手を選択"></div>
    </div>
  </div>

  <div class="container" style="margin-top:10px">
    <div class="card" style="display:flex;flex-direction:column">
      <div id="chat" class="chat" aria-live="polite"></div>
      <div class="inputRow">
        <input id="text" placeholder="メッセージを入力" />
        <button id="send">送信</button>
      </div>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbz6LDVGyhdhedd9h_XWT9eQAxTPsx1TiNqtKBxe60YnJBXoajVQbjff47wDSZTxbqnxng/exec";

const $ = (id)=>document.getElementById(id);
let me = { userId: null };
let roomId = null;
let since = null;
let pollTimer = null;

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

function scrollBottom(){ const c = $('chat'); c.scrollTop = c.scrollHeight; }

function renderPeers(list){
  const box = $('peers'); box.innerHTML = '';
  if(!list.length){
    const empty = document.createElement('div'); empty.className='peer';
    empty.innerHTML = '<div class="name">相手がいません</div><div class="sub">登録者を増やしてください</div>';
    box.appendChild(empty); return;
  }
  list.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'peer';
    el.innerHTML = `<div class="name">${p.name}</div><div class="sub">${p.store || ''}</div>`;
    el.onclick = async ()=>{
      document.querySelectorAll('.peer').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      const room = await callServer({ action:'room', idToken: liff.getIDToken(), otherUserId: p.userId });
      roomId = room.roomId; since = null; $('chat').innerHTML = '';
      startPolling();
    };
    box.appendChild(el);
  });
}

function renderMessages(items){
  const c = $('chat');
  items.forEach(m=>{
    const mine = (m.fromUserId === me.userId);
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (mine ? 'me' : 'them');
    const time = new Date(m.createdAt);
    wrap.innerHTML = `${m.text}<div class="time">${time.toLocaleString()}</div>`;
    c.appendChild(wrap);
    since = m.createdAt;
  });
  scrollBottom();
}

async function startPolling(){
  if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
  await loadOnce();
  pollTimer = setInterval(loadOnce, 2000);
}

async function loadOnce(){
  if(!roomId) return;
  const res = await callServer({ action:'history', idToken: liff.getIDToken(), roomId, since });
  renderMessages(res.messages || []);
}

$('send').onclick = async ()=>{
  const text = $('text').value.trim();
  if(!text || !roomId) return;
  $('text').value = '';
  await callServer({ action:'send', idToken: liff.getIDToken(), roomId, text });
  renderMessages([{ createdAt:new Date().toISOString(), fromUserId:me.userId, text }]); // ローカル即時反映
};

(async ()=>{
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }

  const st = await callServer({ action:'status', idToken: liff.getIDToken() });
  if(!st.bound){ location.replace('./register.html'); return; }
  me.userId = st.userId;

  const list = await callServer({ action:'members', idToken: liff.getIDToken() });
  renderPeers(list.members || []);
})();
</script>
</body>
</html>
