<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>シフト</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%;overflow-x:hidden}
html{-webkit-text-size-adjust:100%}
body{
  margin:0;background:#f6f8fc;color:#0f172a;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;
  display:flex;flex-direction:column
}
/* container */
.header{padding:16px;font-weight:800;font-size:18px}
.note{
  background:#fff3cd;color:#663c00;
  font-size:14px;padding:8px 16px;margin:0;
  border-bottom:1px solid #ffeeba
}
.container{flex:1;max-width:980px;margin:0 auto;padding:12px 16px 80px}

/* パンくず */
.breadcrumb{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:8px 0 10px}
.bc{font-size:12px;color:#2563eb;cursor:pointer}
.sep{opacity:.4}

/* フォルダ一覧 */
.flist{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:12px}
.fitem{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;cursor:pointer}
.ficon{width:36px;height:36px;border-radius:8px;background:#e2e8f0;display:flex;align-items:center;justify-content:center}
.ficon .material-icons{font-size:22px;color:#0f172a}
.fmeta{min-width:0;display:flex;flex-direction:column;gap:2px}
.ftitle{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fsub{font-size:12px;opacity:.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* 画像リスト */
.img-list{display:flex;flex-direction:column;gap:16px}
.img-item{
  position:relative;
  background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:12px;
  padding:10px
}
.img-item .label{
  position:absolute;right:14px;bottom:14px;   /* ← 右下 */
  max-width:calc(100% - 28px);
  font-size:12px;font-weight:700;color:#fff;
  background:rgba(15,23,42,.7);
  padding:6px 10px;border-radius:999px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  pointer-events:none;
}
img{max-width:100%;height:auto;display:block;border-radius:8px}

/* loader */
.loader{display:flex;justify-content:center;align-items:center;padding:24px}
.spin{width:18px;height:18px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:#06c755;animation:sp 1s linear infinite;margin-right:8px}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{padding:24px;text-align:center;opacity:.7}

/* bottom nav */
.bottom-nav{display:flex;justify-content:space-around;align-items:center;height:56px;background:#fff;border-top:1px solid rgba(2,6,23,.08);position:fixed;bottom:0;left:0;right:0;z-index:50}
.bottom-nav button{flex:1;appearance:none;background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;color:#475569;padding:4px 0;position:relative}
.bottom-nav .material-icons{font-size:24px;color:#0f172a}
.badge-dot{position:absolute;right:20px;top:6px;min-width:16px;height:16px;padding:0 4px;border-radius:999px;background:#ef4444;color:#fff;font-size:10px;line-height:16px;font-weight:700;display:none}
</style>
</head>
<body>
  <div class="header">シフト</div>
  <p class="note">画像は長押し後に「保存」を押すと写真として保存できます</p>

  <div class="container">
    <div class="breadcrumb" id="bc"></div>
    <div id="loader" class="loader"><div class="spin"></div>読み込み中…</div>

    <div id="foldersSec"><div id="folders" class="flist"></div></div>
    <div id="imagesSec"><div id="images" class="img-list"></div></div>
    <div id="empty" class="empty" style="display:none">項目がありません</div>
  </div>

  <nav class="bottom-nav">
    <button onclick="location.href='./index.html'"><span class="material-icons">home</span><div>ホーム</div></button>
    <button onclick="location.href='./contacts.html'"><span class="material-icons">chat</span><div>チャット</div><span class="badge-dot" id="chatBadge"></span></button>
    <button onclick="location.href='./shift.html'"><span class="material-icons">calendar_month</span><div>シフト</div></button>
    <button onclick="location.href='./tools.html'"><span class="material-icons">build</span><div>ツール</div></button>
    <button onclick="location.href='./settings.html'"><span class="material-icons">settings</span><div>設定</div></button>
  </nav>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyxBexOLjluMXHLrsW4Ur3GqITKHemtWoUFOxtavcglNuYVz0wvR9a6XZl4h-Lqm3pNHg/exec";
const URL_REGISTER = "./register.html";
const $ = id => document.getElementById(id);

function fmtDate(iso){
  if(!iso) return '';
  const d = new Date(iso); const z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}
function buildDriveImageUrl(fileId){ return `https://lh3.googleusercontent.com/d/${fileId}`; }
async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

/* パンくず */
const trail=[];
function renderBreadcrumb(){
  const bc=$('bc'); bc.innerHTML='';
  if(trail.length===0) return;
  trail.forEach((t,i)=>{
    const span=document.createElement('span'); span.className='bc'; span.textContent=t.name; span.onclick=()=>jumpTo(i);
    bc.appendChild(span);
    if(i<trail.length-1){ const s=document.createElement('span'); s.className='sep'; s.textContent='›'; bc.appendChild(s); }
  });
}
function jumpTo(index){
  const target=trail[index]; trail.splice(index+1);
  renderBreadcrumb(); loadFolder(target.id,true);
}

/* フォルダ */
function renderFolders(list){
  const box=$('folders'); box.innerHTML='';
  if(!list.length){ $('foldersSec').style.display='none'; return; }
  $('foldersSec').style.display='';
  list.forEach(f=>{
    const el=document.createElement('div'); el.className='fitem';
    el.innerHTML=`<div class="ficon"><span class="material-icons">folder</span></div>
                  <div class="fmeta"><div class="ftitle">${f.name}</div>
                  <div class="fsub">${fmtDate(f.updatedAt||f.createdAt)}</div></div>`;
    el.onclick=()=>{ trail.push({id:f.id,name:f.name}); renderBreadcrumb(); loadFolder(f.id,true); };
    box.appendChild(el);
  });
}

/* 画像 */
function renderImages(list){
  const box=$('images'); box.innerHTML='';
  const imgs=(list||[]).filter(f=>(f.mimeType||'').startsWith('image/'));
  if(!imgs.length){
    $('imagesSec').style.display='none';
    $('empty').style.display=($('folders').children.length===0)?'':'none';
    return;
  }
  $('imagesSec').style.display='';
  imgs.forEach(f=>{
    const wrap=document.createElement('div'); wrap.className='img-item';
    const label=document.createElement('div'); label.className='label'; label.textContent=f.name||''; label.title=f.name||'';
    wrap.appendChild(label);
    const img=document.createElement('img'); img.src=buildDriveImageUrl(f.id); img.alt=f.name||'image';
    wrap.appendChild(img);
    box.appendChild(wrap);
  });
  $('empty').style.display='none';
}

/* 読み込み */
async function loadFolder(folderId,showLoading){
  try{
    if(showLoading){ $('loader').style.display='flex'; }
    const res=await callServer({ action:'shiftChildren', idToken:liff.getIDToken(), folderId });
    renderFolders(res.folders||[]); renderImages(res.images||[]);
  }catch(e){
    console.error(e); $('empty').style.display=''; $('foldersSec').style.display='none'; $('imagesSec').style.display='none';
  }finally{ $('loader').style.display='none'; }
}

/* 初期化 */
(async ()=>{
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  const st=await callServer({ idToken:liff.getIDToken(), action:'status' });
  if(!st.bound){ location.replace(URL_REGISTER); return; }

  const root=await callServer({ action:'shiftRoots', idToken:liff.getIDToken() });
  trail.length=0; trail.push({id:root.folder.id,name:root.folder.name});
  renderBreadcrumb(); renderFolders(root.folders||[]); renderImages(root.images||[]);
  $('loader').style.display='none';
  setupUnreadBadge();
})();

/* 未読バッジ */
async function setupUnreadBadge(){
  const badge=$('chatBadge'); if(!badge) return;
  async function refresh(){
    try{
      const r=await callServer({ action:'unreadTotal', idToken:liff.getIDToken() });
      const n=Number(r.unread||0);
      if(n>0){ badge.textContent=n>99?'99+':n; badge.style.display='inline-block'; }
      else{ badge.style.display='none'; }
    }catch(e){}
  }
  await refresh(); setInterval(refresh,5000);
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') refresh(); });
}
</script>
</body>
</html>
