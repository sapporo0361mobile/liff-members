<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>シフト</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{height:100%;overflow-x:hidden}
body{margin:0;background:#f6f8fc;color:#0f172a;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;display:flex;flex-direction:column}

/* Header & container */
.header{padding:16px 16px 0;font-weight:800;font-size:18px}
.container{flex:1;max-width:980px;margin:0 auto;padding:12px 16px 80px}

/* Breadcrumb */
.breadcrumb{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:8px 0 10px}
.bc{font-size:12px;color:#2563eb;cursor:pointer}
.sep{opacity:.4}

/* Folder list */
.fgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:12px}
.fcard{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;cursor:pointer}
.ficon{width:36px;height:36px;border-radius:8px;background:#e2e8f0;display:flex;align-items:center;justify-content:center}
.ficon .material-icons{font-size:22px;color:#0f172a}
.fmeta{min-width:0;display:flex;flex-direction:column;gap:2px}
.ftitle{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fsub{font-size:12px;opacity:.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Image grid (embedded images directly) */
.igrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.icard{background:#fff;border:1px solid rgba(2,6,23,.08);border-radius:12px;overflow:hidden}
.thumb{width:100%;background:#000;display:flex;align-items:center;justify-content:center;min-height:180px}
.thumb img{width:100%;height:auto;display:block;object-fit:contain;background:#111}
.imeta{padding:8px 10px;border-top:1px solid rgba(2,6,23,.06);font-size:12px;color:#475569;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Misc */
.loader{display:flex;justify-content:center;align-items:center;padding:24px}
.spin{width:18px;height:18px;border-radius:50%;border:3px solid #cbd5e1;border-top-color:#06c755;animation:sp 1s linear infinite;margin-right:8px}
@keyframes sp{to{transform:rotate(360deg)}}
.empty{padding:24px;text-align:center;opacity:.7}

/* bottom nav + 未読バッジ（他ページと統一） */
.bottom-nav{display:flex;justify-content:space-around;align-items:center;height:56px;background:#fff;border-top:1px solid rgba(2,6,23,.08);position:fixed;bottom:0;left:0;right:0;z-index:50}
.bottom-nav button{flex:1;appearance:none;background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;color:#475569;padding:4px 0;position:relative}
.bottom-nav .material-icons{font-size:24px;color:#0f172a}
.badge-dot{position:absolute;right:20px;top:6px;min-width:16px;height:16px;padding:0 4px;border-radius:999px;background:#ef4444;color:#fff;font-size:10px;line-height:16px;font-weight:700;display:none}
</style>
</head>
<body>
  <div class="header">シフト</div>
  <div class="container">
    <div class="breadcrumb" id="bc"></div>

    <div id="loader" class="loader"><div class="spin"></div>読み込み中…</div>

    <!-- フォルダのみ（見出しなし） -->
    <div id="foldersSec">
      <div id="folders" class="fgrid"></div>
    </div>

    <!-- 画像（見出しなし） -->
    <div id="imagesSec">
      <div id="images" class="igrid"></div>
    </div>

    <div id="empty" class="empty" style="display:none">項目がありません</div>
  </div>

  <nav class="bottom-nav">
    <button onclick="location.href='./index.html'"><span class="material-icons">home</span><div>ホーム</div></button>
    <button onclick="location.href='./contacts.html'"><span class="material-icons">chat</span><div>チャット</div><span class="badge-dot" id="chatBadge"></span></button>
    <button onclick="location.href='./shift.html'"><span class="material-icons">calendar_month</span><div>シフト</div></button>
    <button onclick="location.href='./tools.html'"><span class="material-icons">build</span><div>ツール</div></button>
    <button onclick="location.href='./settings.html'"><span class="material-icons">settings</span><div>設定</div></button>
  </nav>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyEx8f6xOOCo7f39LZa0yPRHZFRKrWwS4DxLyHC9znxTkhxyttPaDRO7F30hYjcObPMSQ/exec";
const URL_REGISTER = "./register.html";
const $ = id => document.getElementById(id);

/* ===== helpers ===== */
function fmtDate(iso){
  if(!iso) return '';
  const d = new Date(iso); const z = n=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
}
function isImageEntry(f){
  const mt = (f.mimeType||'').toLowerCase();
  if(mt.startsWith('image/')) return true;
  return /\.(png|jpe?g|gif|webp|bmp|heic|heif|tif?f)$/i.test(f.name||'');
}
async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}

/* ===== breadcrumb ===== */
const trail = []; // [{id,name}]
function renderBreadcrumb(){
  const bc = $('bc'); bc.innerHTML = '';
  if(trail.length===0) return;
  trail.forEach((t,i)=>{
    const span = document.createElement('span'); span.className = 'bc'; span.textContent = t.name; span.onclick = ()=> jumpTo(i);
    bc.appendChild(span);
    if(i < trail.length-1){ const s=document.createElement('span'); s.className='sep'; s.textContent='›'; bc.appendChild(s); }
  });
}
function jumpTo(index){
  const target = trail[index];
  trail.splice(index+1);
  renderBreadcrumb();
  loadFolder(target.id, true);
}

/* ===== folders ===== */
function renderFolders(list){
  const box = $('folders'); box.innerHTML = '';
  if(!list.length){ $('foldersSec').style.display='none'; return; }
  $('foldersSec').style.display='';
  list.forEach(f=>{
    const el = document.createElement('div'); el.className = 'fcard';
    el.innerHTML = `
      <div class="ficon"><span class="material-icons">folder</span></div>
      <div class="fmeta">
        <div class="ftitle">${f.name}</div>
        <div class="fsub">${fmtDate(f.updatedAt||f.createdAt)}</div>
      </div>`;
    el.onclick = ()=>{
      trail.push({id:f.id, name:f.name});
      renderBreadcrumb();
      loadFolder(f.id, true);
    };
    box.appendChild(el);
  });
}

/* ===== images (ALL eager load & embed) ===== */
async function renderImages(list){
  const box = $('images'); box.innerHTML = '';
  const imgs = (list||[]).filter(isImageEntry);

  if(!imgs.length){
    $('imagesSec').style.display='none';
    $('empty').style.display = ($('folders').children.length===0) ? '' : 'none';
    return;
  }
  $('imagesSec').style.display='';

  // すべての画像を最初から取得して Data URL で埋め込み表示
  const tasks = imgs.map(async f=>{
    const wrap = document.createElement('div'); wrap.className='icard';
    wrap.innerHTML = `
      <div class="thumb"><img alt="読み込み中…" /></div>
      <div class="imeta" title="${f.name}">${f.name}　${fmtDate(f.updatedAt||f.createdAt)}</div>`;
    box.appendChild(wrap);

    try{
      const res = await callServer({ action:'shiftGet', idToken: liff.getIDToken(), fileId: f.id });
      if(!(res.mimeType||'').startsWith('image/')) throw new Error('not image');
      const dataUrl = `data:${res.mimeType};base64,${res.base64}`;
      const img = wrap.querySelector('img');
      img.src = dataUrl;
      img.alt = res.name || f.name || 'image';
    }catch(e){
      const img = wrap.querySelector('img');
      img.alt = '読み込み失敗';
      img.style.opacity = .5;
    }
  });

  // 全件完了を待ってから空表示の制御（“表示域以外も全て表示”のため待機）
  await Promise.all(tasks);
  $('empty').style.display = 'none';
}

/* ===== load folder ===== */
async function loadFolder(folderId, showLoading){
  try{
    if(showLoading){ $('loader').style.display='flex'; }
    const res = await callServer({ action:'shiftChildren', idToken: liff.getIDToken(), folderId });
    renderFolders(res.folders||[]);
    await renderImages(res.images||[]); // ← 全件 eager load
  }catch(e){
    console.error(e);
    $('empty').style.display='';
    $('foldersSec').style.display='none';
    $('imagesSec').style.display='none';
  }finally{
    $('loader').style.display='none';
  }
}

/* ===== init ===== */
(async ()=>{
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  const st = await callServer({ action:'status', idToken: liff.getIDToken() });
  if(!st.bound){ location.replace(URL_REGISTER); return; }

  // ルート（最上位フォルダをパンくずに設定）
  const root = await callServer({ action:'shiftRoots', idToken: liff.getIDToken() });
  trail.length = 0;
  trail.push({ id: root.folder.id, name: root.folder.name });
  renderBreadcrumb();
  renderFolders(root.folders||[]);
  await renderImages(root.images||[]); // ← 初期表示も全件 eager load
  $('loader').style.display='none';

  setupUnreadBadge();
})();

/* ===== 未読バッジ ===== */
async function setupUnreadBadge(){
  const badge = $('chatBadge'); if(!badge) return;
  async function refresh(){
    try{
      const r = await callServer({ action:'unreadTotal', idToken: liff.getIDToken() });
      const n = Number(r.unread||0);
      if(n>0){ badge.textContent = n>99?'99+':n; badge.style.display='inline-block'; }
      else{ badge.style.display='none'; }
    }catch(e){}
  }
  await refresh();
  setInterval(refresh, 5000);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') refresh(); });
}
</script>
</body>
</html>
