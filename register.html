<!doctype html>
<html lang="ja">
<head>

<!-- ① LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- ② あなたの LIFF ID を設定 -->
<script>window.LIFF_ID = "2007972627-vnAq4qbB";</script>

<!-- ③ LINEアプリ外ブロック用ガード：すべてのHTMLで共通に貼る -->
<style id="liff-guard-style">body{display:none!important}</style>
<script>
(function(){
  var LIFF_ID = window.LIFF_ID || "";
  function allow(){
    var st=document.getElementById('liff-guard-style'); if(st) st.remove();
    if(document.body) document.body.style.display='';
  }
  function block(){
    var deeplink = LIFF_ID ? ('https://liff.line.me/' + encodeURIComponent(LIFF_ID)) : '';
    document.open();
    document.write(
      '<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
      '<title>このページはLINEアプリ専用です</title>'+
      '<style>html,body{height:100%}body{margin:0;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Arial}'+
      '.card{max-width:720px;margin:0 16px;background:#111827;border-radius:14px;padding:18px 16px;border:1px solid rgba(255,255,255,.08)}'+
      '.h{font-weight:800;margin:4px 0 8px;font-size:16px}.p{opacity:.9;line-height:1.6;font-size:14px}'+
      '.btn{margin-top:12px;display:inline-block;background:#06c755;color:#0b2314;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:700}'+
      '</style>'+
      '<div class="card">'+
        '<div class="h">このページは LINE アプリ内でのみ利用できます</div>'+
        '<div class="p">LINE のトーク、または <b>ホーム → サービス</b> から開き直してください。</div>' +
        (deeplink ? '<a class="btn" href="'+deeplink+'">LINEで開く</a>' : '')+
      '</div>'
    );
    document.close();
  }
  function uaLooksLikeLine(){
    var ua = navigator.userAgent || '';
    return /Line\/|LIFF/i.test(ua);
  }
  // SDKが無くてもUAでできるだけ判定
  if(!window.liff){
    if(uaLooksLikeLine()){ allow(); } else { block(); }
    return;
  }
  // LIFF初期化 → アプリ内かどうかで判定
  liff.init({ liffId: LIFF_ID }).then(function(){
    if(liff.isInClient()){ allow(); } else { block(); }
  }).catch(function(){
    if(uaLooksLikeLine()){ allow(); } else { block(); }
  });
})();
</script>
  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>初回利用登録</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden}
html{-webkit-text-size-adjust:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;background:#fff;color:#111}
.wrap{min-height:100svh;min-height:100dvh;width:100%;
  padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);
  padding-top:calc(env(safe-area-inset-top) + 8px);padding-bottom:calc(env(safe-area-inset-bottom) + 16px)}
img,video,canvas,svg{max-width:100%;height:auto;display:block}
.container{width:100%;max-width:720px;margin:0 auto;padding:0 16px}
.card{width:100%;max-width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
h1{margin:0 0 8px}
.muted{opacity:.75}
.sheet{display:grid;gap:12px;margin-top:8px}
.fld{display:grid;gap:6px}
.fld label{font-size:14px;color:#374151}
.fld input,.fld select{appearance:none;width:100%;max-width:100%;font-size:16px;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
.btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-size:16px;cursor:pointer;background:#06c755;color:#fff}
.link{color:#2563eb;text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <div class="container">
    <div class="card">
      <h1>利用登録</h1>
      <div id="sub" class="muted">所属店舗・職員コード・氏名を入力してください</div>

      <div class="sheet">
        <div class="fld">
          <label for="store">所属店舗</label>
          <select id="store"><option value="">選択してください</option></select>
        </div>
        <div class="fld">
          <label for="code">職員コード（数字）</label>
          <input id="code" inputmode="numeric" pattern="[0-9]*" placeholder="例：12345">
        </div>
        <div class="fld">
          <label for="lastName">姓</label>
          <input id="lastName" placeholder="例：山田">
        </div>
        <div class="fld">
          <label for="firstName">名</label>
          <input id="firstName" placeholder="例：太郎">
        </div>
        <div class="actions">
          <button id="submit" class="btn">登録する</button>
        </div>
        <div id="msg" class="muted"></div>
        <div class="muted">登録済みの方は <a class="link" href="./home.html">会員ページ</a> へ</div>
      </div>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzJc0m-1QpRfS_elBV5PyUHOVYCqezuB8Qp3wluj1gvt1LwCzjV-nwsBRySOlPOadN-YA/exec";
const URL_HOME = "./home.html";
const $ = (id)=>document.getElementById(id);

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}
function fillStores(list){
  const sel = $('store'); sel.innerHTML = '<option value="">選択してください</option>';
  (list||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
}

(async ()=>{
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const idToken = liff.getIDToken();
    const st = await callServer({ idToken, action:"status" });
    if(st.bound){ location.replace(URL_HOME); return; }
    const stores = await callServer({ idToken, action:"stores" });
    fillStores(stores.stores);
  }catch(err){
    console.error(err); $('msg').textContent = '初期化エラー：'+(err?.message||err);
  }
})();

$('submit').addEventListener('click', async ()=>{
  try{
    const store = $('store').value.trim();
    const code  = $('code').value.trim();
    const ln    = $('lastName').value.trim();
    const fn    = $('firstName').value.trim();
    if(!store) throw new Error('所属店舗を選んでください');
    if(!/^[0-9]+$/.test(code)) throw new Error('職員コードは数字で入力してください');
    if(!ln || !fn) throw new Error('姓・名を入力してください');

    $('msg').textContent = '登録中…';
    const idToken = liff.getIDToken();
    await callServer({ idToken, action:"bind", store, staffCode:code, lastName:ln, firstName:fn });
    $('msg').textContent = '登録完了。会員ページへ移動します…';
    location.replace(URL_HOME);
  }catch(err){
    console.error(err); $('msg').textContent = 'エラー：'+(err?.message||err);
  }
});
</script>
</body>
</html>
