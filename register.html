<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>会員登録</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
/* --- Anti-Overflow Patch (共通) --- */
*,*::before,*::after{box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden}
html{-webkit-text-size-adjust:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial;background:#fff;color:#111}
.wrap{min-height:100svh;min-height:100dvh;width:100%;
  padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);
  padding-top:calc(env(safe-area-inset-top) + 8px);padding-bottom:calc(env(safe-area-inset-bottom) + 16px)}
img,video,canvas,svg{max-width:100%;height:auto;display:block}

/* --- layout --- */
.container{width:100%;max-width:720px;margin:0 auto;padding:0 16px}
.card{width:100%;max-width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
h1{margin:0 0 8px}
.muted{opacity:.75}
.sheet{display:grid;gap:12px;margin-top:8px}
.fld{display:grid;gap:6px}
.fld label{font-size:14px;color:#374151}
.fld input,.fld select{appearance:none;width:100%;max-width:100%;font-size:16px;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
.btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-size:16px;cursor:pointer;background:#06c755;color:#fff}
.link{color:#2563eb;text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <div class="container">
    <div class="card">
      <h1>会員登録</h1>
      <div id="sub" class="muted">所属店舗・職員コード・氏名を入力してください</div>

      <div class="sheet">
        <div class="fld">
          <label for="store">所属店舗</label>
          <select id="store"><option value="">選択してください</option></select>
        </div>
        <div class="fld">
          <label for="code">職員コード（数字）</label>
          <input id="code" inputmode="numeric" pattern="[0-9]*" placeholder="例：12345">
        </div>
        <div class="fld">
          <label for="lastName">姓</label>
          <input id="lastName" placeholder="例：山田">
        </div>
        <div class="fld">
          <label for="firstName">名</label>
          <input id="firstName" placeholder="例：太郎">
        </div>
        <div class="actions">
          <button id="submit" class="btn">登録する</button>
        </div>
        <div id="msg" class="muted"></div>
        <div class="muted">登録済みの方は <a class="link" href="./home.html">会員ページ</a> へ</div>
      </div>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2007972627-vnAq4qbB";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby042IR537_dOHo0XTri9kTgdwZVRQQFO_vIJuFLW3_gSkmWQYoVqx0vBFxuDSTAxZajQ/exec"; // ← 差し替え
const URL_HOME = "./home.html";

const $ = (id)=>document.getElementById(id);

async function callServer(payload){
  const r = await fetch(GAS_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ j={ok:false,error:"JSON parse failed: "+t} }
  if(!r.ok || !j.ok) throw new Error(j.error||("HTTP "+r.status));
  return j;
}
function fillStores(list){
  const sel = $('store'); sel.innerHTML = '<option value="">選択してください</option>';
  (list||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
}

(async ()=>{
  try{
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const idToken = liff.getIDToken();
    const st = await callServer({ idToken, action:"status" });
    if(st.bound){ location.replace(URL_HOME); return; }
    const stores = await callServer({ idToken, action:"stores" });
    fillStores(stores.stores);
  }catch(err){
    console.error(err); $('msg').textContent = '初期化エラー：'+(err?.message||err);
  }
})();

$('submit').addEventListener('click', async ()=>{
  try{
    const store = $('store').value.trim();
    const code  = $('code').value.trim();
    const ln    = $('lastName').value.trim();
    const fn    = $('firstName').value.trim();
    if(!store) throw new Error('所属店舗を選んでください');
    if(!/^[0-9]+$/.test(code)) throw new Error('職員コードは数字で入力してください');
    if(!ln || !fn) throw new Error('姓・名を入力してください');

    $('msg').textContent = '登録中…';
    const idToken = liff.getIDToken();
    await callServer({ idToken, action:"bind", store, staffCode:code, lastName:ln, firstName:fn });
    $('msg').textContent = '登録完了。会員ページへ移動します…';
    location.replace(URL_HOME);
  }catch(err){
    console.error(err); $('msg').textContent = 'エラー：'+(err?.message||err);
  }
});
</script>
</body>
</html>
